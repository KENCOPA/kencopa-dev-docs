---
type: note
moc: "[[🏷️standard]]"
---
# 🎯 目的・対象範囲

- **目的**
  - フロントエンド開発におけるテスト実装の方針を定め、効率的かつ実用的なテスト戦略を確立する
- **対象範囲**
  - フロントエンド開発者全員
  - React プロジェクト全般

# ⌛ 背景

- 従来のテスト戦略では網羅性を重視するあまり、開発効率を阻害する場合があった
- 実際の開発現場では、高リスク箇所に集中したテストがより実用的であることが判明
- チーム全体でテスト実装判断のタイミングを統一する必要が生まれた

# 🌳 全体指針

- **コンポーネントテスト、フックテスト、ロジックテスト、E2E テストはいずれも必須ではありません**
- **自分が不安に感じる箇所に重点的にテストを行い、単純なロジックや影響範囲が小さい部分についてはテストを省略しても構いません**

## テスト実装を推奨する箇所（不安に感じやすい箇所）

- **複数の条件分岐があるロジック**
- **外部 API との連携部分**
- **金額計算など重要なビジネスロジック**
- **過去にバグが発生した箇所**
- **複雑な状態管理を行うコンポーネント**
- **フォームのバリデーション処理**

## テスト実装コストの目安

- **30 分以内で書けない複雑なテストは一旦見送る**
- **モックが複雑になりすぎる場合は実装方法を見直す**
- **テストコードがプロダクションコードより長くなる場合は要検討**

## テスト実装判断のタイミング

- **スプリントプランニング**で高リスク・高不安箇所を洗い出し、必要なテストを決定
- **プルリクエストレビュー**で変更範囲に応じて追加テストの要否を検討

## やらないこと

- StoryBook によるコンポーネント可視化

# 🍃 詳細

## テストの種類と使用ツール

### 1. コンポーネントテスト

- **ツール**: React Testing Library & Vitest
- **内容**:

  - 各コンポーネントが正しくレンダリングされるかを検証
  - Props や状態による挙動の変化をテスト
  - コンポーネント間の連携やイベントハンドリングの挙動を確認

- **具体例**: `MyButton` コンポーネントのテスト

  ```tsx
  // __tests__/MyButton.test.tsx
  import { render, screen, fireEvent } from "@testing-library/react";
  import { describe, it, expect, vi } from "vitest";
  import MyButton from "../components/MyButton";

  describe("MyButton コンポーネント", () => {
    it("ラベルが正しく表示され、クリックイベントが発火する", () => {
      const handleClick = vi.fn();
      render(<MyButton label="クリックしてね" onClick={handleClick} />);

      const button = screen.getByRole("button", { name: /クリックしてね/i });
      expect(button).toBeInTheDocument();

      fireEvent.click(button);
      expect(handleClick).toHaveBeenCalledTimes(1);
    });

    it("disabled prop が true のときはクリックを受け付けない", () => {
      const handleClick = vi.fn();
      render(<MyButton label="無効" onClick={handleClick} disabled />);

      const button = screen.getByRole("button", { name: /無効/i });
      expect(button).toBeDisabled();

      fireEvent.click(button);
      expect(handleClick).not.toHaveBeenCalled();
    });
  });
  ```

### 2. フックテスト（フォーム）

- **ツール**: Vitest & @testing-library/react-hooks
- **内容**:

  - useUpdateSiteForm の初期値、バリデーション、handleSubmit の動作をテスト

- **具体例**: useUpdateSiteForm のテスト

  ```tsx
  // __tests__/useUpdateSiteForm.test.ts
  import { renderHook, act } from "@testing-library/react-hooks";
  import { describe, it, expect, vi } from "vitest";
  import {
    useUpdateSiteForm,
    UpdateSiteFormSchemaType,
  } from "../hooks/useUpdateSiteForm";

  describe("useUpdateSiteForm フック", () => {
    const validDefaults: UpdateSiteFormSchemaType = {
      siteId: "S123",
      name: "現場A",
      description: "詳細",
      address: "住所",
      clientName: "顧客",
      startAt: null,
      endAt: null,
      departmentId: undefined,
      branchId: undefined,
    };

    it("初期値が defaultValues で上書きされる", () => {
      const updateSite = vi.fn();
      const { result } = renderHook(() =>
        useUpdateSiteForm({ updateSite, defaultValues: validDefaults })
      );
      expect(result.current.form.getValues()).toEqual(validDefaults);
    });

    it("handleSubmit で updateSite が呼ばれ、フォームがリセットされる", async () => {
      const updateSite = vi.fn();
      const { result } = renderHook(() =>
        useUpdateSiteForm({ updateSite, defaultValues: validDefaults })
      );

      await act(async () => {
        await result.current.handleSubmit();
      });

      expect(updateSite).toHaveBeenCalledWith(validDefaults);
      expect(result.current.form.getValues()).toEqual(validDefaults);
    });

    it("バリデーションエラー時には updateSite が呼ばれない", async () => {
      const updateSite = vi.fn();
      const { result } = renderHook(() => useUpdateSiteForm({ updateSite }));

      await act(async () => {
        await result.current.handleSubmit();
      });

      expect(updateSite).not.toHaveBeenCalled();
      expect(result.current.form.formState.errors.siteId).toBeDefined();
    });
  });
  ```

### 3. ロジックテスト（カスタムフック）

- **ツール**: Vitest & @testing-library/react-hooks
- **内容**:

  - ドメインロジックを切り出したカスタムフックを直接テスト
  - 入力と出力、内部ステート遷移を検証

- **具体例**: 日付範囲チェックを行う useDateRange フックのテスト

  ```tsx
  // hooks/useDateRange.ts
  import { useState } from "react";

  export function useDateRange() {
    const [range, setRange] = useState<{ start?: Date; end?: Date }>({});
    const setStart = (d: Date) => setRange((r) => ({ ...r, start: d }));
    const setEnd = (d: Date) => setRange((r) => ({ ...r, end: d }));
    const isValid = () => {
      if (!range.start || !range.end) return false;
      return range.start <= range.end;
    };
    return { range, setStart, setEnd, isValid };
  }

  // __tests__/useDateRange.test.ts
  import { renderHook, act } from "@testing-library/react-hooks";
  import { describe, it, expect } from "vitest";
  import { useDateRange } from "../hooks/useDateRange";

  describe("useDateRange フック", () => {
    it("日付範囲の初期状態は無効", () => {
      const { result } = renderHook(() => useDateRange());
      expect(result.current.isValid()).toBe(false);
    });

    it("開始日・終了日をセットすると有効判定される", () => {
      const { result } = renderHook(() => useDateRange());
      act(() => {
        result.current.setStart(new Date("2025-01-01"));
        result.current.setEnd(new Date("2025-01-10"));
      });
      expect(result.current.isValid()).toBe(true);
    });

    it("開始日が終了日より後だと無効", () => {
      const { result } = renderHook(() => useDateRange());
      act(() => {
        result.current.setStart(new Date("2025-02-01"));
        result.current.setEnd(new Date("2025-01-10"));
      });
      expect(result.current.isValid()).toBe(false);
    });
  });
  ```

### 4. E2E テスト（LLM ワークフロー）

- **ツール**: workflow-use
- **内容**:
  - LLM を活用した直感的なテストフロー生成を検討
  - Cypress/Playwright の代替として、自然言語プロンプトでユースケースを記述すると、バックグラウンドでワークフローが自動生成・実行される仕組みを目指す
  - 現時点では PoC 段階だが、最終的にテストシナリオの自動生成と結果検証までシームレスに行える体験を目指す

# **📎 付録（必要に応じて）**

- **用語集**

  - コンポーネントテスト: 個別の React コンポーネントの振る舞いを検証するテスト
  - フックテスト: カスタムフックの動作を検証するテスト
  - ロジックテスト: ビジネスロジックを分離してテストする手法

- **参考ツール**

  - React Testing Library: https://testing-library.com/docs/react-testing-library/intro/
  - Vitest: https://vitest.dev/
  - @testing-library/react-hooks: https://react-hooks-testing-library.com/

- **テンプレート一式**
  - 上記具体例を参考に、各プロジェクトに適した形でテストを実装してください
