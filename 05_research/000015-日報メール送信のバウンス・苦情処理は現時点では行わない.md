---
type: note
moc: "[[🏷️ADR]]"
---
# 📜 文脈・背景

## 問題

日報メール送信機能において、Amazon SESから送信されるメールのバウンス（不達）や苦情（スパム報告）を自動的に検出・処理するためのSNS（Simple Notification Service）連携システムの実装を検討している。この決定は、システムの開発コスト、運用リスク、およびAWS SESアカウントの健全性に影響を与える。

## 現在の状況

- 日報メール送信システムの開発中
- Amazon SESを使用したメール送信機能を実装予定
- 基本的な送信成功・失敗は `WorkDailyReportRecipientDetail` テーブルで管理
	- SESのメール送信自体が成功したか、失敗したかのみ判定
- SNS連携になどよるバウンス・苦情の自動処理システムは未実装

refs:
- SNS連携方法
```cardlink
url: https://qiita.com/sato_kana/items/54238ba1dc19f6a2c229#%E6%A7%8B%E6%88%90%E5%9B%B3%E6%A6%82%E7%95%A5
title: "Amazon SESで発生したバウンスや苦情を任意のメールアドレスへ通知する仕組みを構築する - Qiita"
description: "はじめにAWSでシステムを構築している場合、メールの送信を行う場合は Amazon Simple Email Service (以降 Amazon SES と記載)を使用するケースが多いかと思いま…"
host: qiita.com
favicon: https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico
image: https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-user-contents.imgix.net%2Fhttps%253A%252F%252Fcdn.qiita.com%252Fassets%252Fpublic%252Farticle-ogp-background-afbab5eb44e0b055cce1258705637a91.png%3Fixlib%3Drb-4.0.0%26w%3D1200%26blend64%3DaHR0cHM6Ly9xaWl0YS11c2VyLXByb2ZpbGUtaW1hZ2VzLmltZ2l4Lm5ldC9odHRwcyUzQSUyRiUyRnNlY3VyZS5ncmF2YXRhci5jb20lMkZhdmF0YXIlMkZiZWU2M2NhZDQ0Y2NiMjFlNTZjMzYzZmE0Yzc1ODE5ZT9peGxpYj1yYi00LjAuMCZhcj0xJTNBMSZmaXQ9Y3JvcCZtYXNrPWVsbGlwc2UmZm09cG5nMzImcz1mM2E2NGE4NjI4ZmIwZWYwNWRiNzljMzYwODlhZjJhNw%26blend-x%3D120%26blend-y%3D462%26blend-w%3D90%26blend-h%3D90%26blend-mode%3Dnormal%26mark64%3DaHR0cHM6Ly9xaWl0YS1vcmdhbml6YXRpb24taW1hZ2VzLmltZ2l4Lm5ldC9odHRwcyUzQSUyRiUyRnMzLWFwLW5vcnRoZWFzdC0xLmFtYXpvbmF3cy5jb20lMkZxaWl0YS1vcmdhbml6YXRpb24taW1hZ2UlMkY4MWRiMjQyZTUwMmNlMTRiOTdjZDQ2ZGZhNmMyYjk4ZDJjNWE1MzkxJTJGb3JpZ2luYWwuanBnJTNGMTY1NjM5MzkwNT9peGxpYj1yYi00LjAuMCZ3PTQ0Jmg9NDQmZml0PWNyb3AmbWFzaz1jb3JuZXJzJmNvcm5lci1yYWRpdXM9OCZib3JkZXI9MiUyQ0ZGRkZGRiZmbT1wbmczMiZzPTA3ZDEwNGUwNzVmZmEwODQ4MGNjYTI3ZjQ3NjZmNWRj%26mark-x%3D186%26mark-y%3D515%26mark-w%3D40%26mark-h%3D40%26s%3De3da8943f3e649f5397820e39aabe962?ixlib=rb-4.0.0&w=1200&fm=jpg&mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTk2MCZoPTMyNCZ0eHQ9QW1hem9uJTIwU0VTJUUzJTgxJUE3JUU3JTk5JUJBJUU3JTk0JTlGJUUzJTgxJTk3JUUzJTgxJTlGJUUzJTgzJTkwJUUzJTgyJUE2JUUzJTgzJUIzJUUzJTgyJUI5JUUzJTgyJTg0JUU4JThCJUE2JUU2JTgzJTg1JUUzJTgyJTkyJUU0JUJCJUJCJUU2JTg0JThGJUUzJTgxJUFFJUUzJTgzJUExJUUzJTgzJUJDJUUzJTgzJUFCJUUzJTgyJUEyJUUzJTgzJTg5JUUzJTgzJUFDJUUzJTgyJUI5JUUzJTgxJUI4JUU5JTgwJTlBJUU3JTlGJUE1JUUzJTgxJTk5JUUzJTgyJThCJUU0JUJCJTk1JUU3JUI1JTg0JUUzJTgxJUJGJUUzJTgyJTkyJUU2JUE3JThCJUU3JUFGJTg5JUUzJTgxJTk5JUUzJTgyJThCJnR4dC1hbGlnbj1sZWZ0JTJDdG9wJnR4dC1jb2xvcj0lMjMxRTIxMjEmdHh0LWZvbnQ9SGlyYWdpbm8lMjBTYW5zJTIwVzYmdHh0LXNpemU9NTYmdHh0LXBhZD0wJnM9OTdlZTU1MzJiNTliZDc0ZGUyMDA2ZjA1ZDM1OTVmYTc&mark-x=120&mark-y=112&blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTgzOCZoPTU4JnR4dD0lNDBzYXRvX2thbmEmdHh0LWNvbG9yPSUyMzFFMjEyMSZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT0zNiZ0eHQtcGFkPTAmcz05NDM0MWM4MDliYjMyMGU3YzMzZTE3ODA2MWU2YWRiOA&blend-x=242&blend-y=454&blend-w=838&blend-h=46&blend-fit=crop&blend-crop=left%2Cbottom&blend-mode=normal&txt64=5qCq5byP5Lya56S-44OQ44Oz44OA44Kk44OK44Og44Kz44K544K_44K444Kq&txt-x=242&txt-y=539&txt-width=838&txt-clip=end%2Cellipsis&txt-color=%231E2121&txt-font=Hiragino%20Sans%20W6&txt-size=28&s=42e6a8948dd16de9d93d145f4e1ab2ef
```

```cardlink
url: https://docs.aws.amazon.com/ja_jp/pinpoint/latest/userguide/channels-email-deliverability-dashboard-bounce-complaint.html#channels-email-deliverability-dashboard-bounce-complaint-alarms
title: "バウンス率、苦情率 - Amazon Pinpoint"
description: "バウンス率および苦情率、メトリクスの表示方法について説明します。"
host: docs.aws.amazon.com
favicon: https://docs.aws.amazon.com/assets/images/favicon.ico
```
```cardlink
url: https://dev.classmethod.jp/articles/amazon-ses-bounce-sns-notification/
title: "Amazon SES で存在しない宛先にメール送信した際のバウンス通知の内容を確認してみた | DevelopersIO"
description: "「存在しないドメインのメールアドレス」「ユーザーが存在しないメールアドレス」宛に Amazon SES からメール送信した際、SNS トピックへのバウンス通知がどのような内容になっているかを確認しました。"
host: dev.classmethod.jp
favicon: https://dev.classmethod.jp/favicon.ico
image: https://devio2023-media.developers.io/wp-content/uploads/2023/08/amazon-ses.png
```

```cardlink
url: https://qiita.com/namasa/items/6f5dac31367ec9694e83
title: "SESでメール一括送信時に考慮すべきことなどについて ～AWS100本ノック～ 18/100 - Qiita"
description: "はじめにAWS SESを利用してメールの大量送信を行う場合、メールテンプレートと呼ばれる件名と本文を定義したテンプレートファイルを作成し、SendBulkEmailというAPIで一括送信することに…"
host: qiita.com
favicon: https://cdn.qiita.com/assets/favicons/public/production-c620d3e403342b1022967ba5e3db1aaa.ico
image: https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-user-contents.imgix.net%2Fhttps%253A%252F%252Fcdn.qiita.com%252Fassets%252Fpublic%252Farticle-ogp-background-afbab5eb44e0b055cce1258705637a91.png%3Fixlib%3Drb-4.0.0%26w%3D1200%26blend64%3DaHR0cHM6Ly9xaWl0YS11c2VyLXByb2ZpbGUtaW1hZ2VzLmltZ2l4Lm5ldC9odHRwcyUzQSUyRiUyRnMzLWFwLW5vcnRoZWFzdC0xLmFtYXpvbmF3cy5jb20lMkZxaWl0YS1pbWFnZS1zdG9yZSUyRjAlMkY4NzkyNCUyRjlkZTU1ZTAxN2QzNTBmZTcwNjkzM2YwODE1MzA1ZTUxMDJiMjFjZDklMkZ4X2xhcmdlLnBuZyUzRjE2NDE5NTEwOTA_aXhsaWI9cmItNC4wLjAmYXI9MSUzQTEmZml0PWNyb3AmbWFzaz1lbGxpcHNlJmZtPXBuZzMyJnM9ZWVkMjZhNjJlMmQyYThiMWIyZTkxNWE4ODY5NjRkNzU%26blend-x%3D120%26blend-y%3D467%26blend-w%3D82%26blend-h%3D82%26blend-mode%3Dnormal%26s%3D74751f4da5d8886d86534f2f9d88ff7a?ixlib=rb-4.0.0&w=1200&fm=jpg&mark64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTk2MCZoPTMyNCZ0eHQ9U0VTJUUzJTgxJUE3JUUzJTgzJUExJUUzJTgzJUJDJUUzJTgzJUFCJUU0JUI4JTgwJUU2JThCJUFDJUU5JTgwJTgxJUU0JUJGJUExJUU2JTk5JTgyJUUzJTgxJUFCJUU4JTgwJTgzJUU2JTg1JUFFJUUzJTgxJTk5JUUzJTgxJUI5JUUzJTgxJThEJUUzJTgxJTkzJUUzJTgxJUE4JUUzJTgxJUFBJUUzJTgxJUE5JUUzJTgxJUFCJUUzJTgxJUE0JUUzJTgxJTg0JUUzJTgxJUE2JTIwJUVGJUJEJTlFQVdTMTAwJUU2JTlDJUFDJUUzJTgzJThFJUUzJTgzJTgzJUUzJTgyJUFGJUVGJUJEJTlFJTIwMTglMkYxMDAmdHh0LWFsaWduPWxlZnQlMkN0b3AmdHh0LWNvbG9yPSUyMzFFMjEyMSZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT01NiZ0eHQtcGFkPTAmcz0zOTA3MmQ0MzliMzhmNWNjNmUyYTNkOTk1NTUwNTFhNA&mark-x=120&mark-y=112&blend64=aHR0cHM6Ly9xaWl0YS11c2VyLWNvbnRlbnRzLmltZ2l4Lm5ldC9-dGV4dD9peGxpYj1yYi00LjAuMCZ3PTgzOCZoPTU4JnR4dD0lNDBuYW1hc2EmdHh0LWNvbG9yPSUyMzFFMjEyMSZ0eHQtZm9udD1IaXJhZ2lubyUyMFNhbnMlMjBXNiZ0eHQtc2l6ZT0zNiZ0eHQtcGFkPTAmcz04YjUzMGE2MTYyODI0OWI5ZDU2MWNkZTJhZDdjNDg2Mg&blend-x=242&blend-y=480&blend-w=838&blend-h=46&blend-fit=crop&blend-crop=left%2Cbottom&blend-mode=normal&s=e534386e4f7e5af514bbba2079e3eba4
```

## AWS SESの制約・リスク

- **バウンス率制限**
	- 5%未満の維持が推奨（超過でアカウント停止リスク）
- **苦情率制限**
	- 0.1%未満の維持が推奨（超過でアカウント停止リスク）
- **レピュテーション管理**
	- 悪化により配信率低下や送信制限
- **サプレッションリスト**
	- 問題アドレスの自動除外が理想的

refs:
```cardlink
url: https://repost.aws/ja/knowledge-center/ses-resolve-account-review-pause
title: "Amazon SES の送信アカウントのレビューまたは一時停止を解決する"
description: "自分の Amazon Simple Email Service (Amazon SES) の送信アカウントがレビュー対象になっていることを知らせる E メールが届きました。あるいは、Amazon SES 送信のアカウントの E メールを送信する機能が一時停止されています。このような問題が発生するのはなぜですか? どうすればこれを解決できますか?"
host: repost.aws
favicon: https://repost.aws/favicon-32x32.png
image: https://a0.awsstatic.com/libra-css/images/logos/aws_logo_smile_1200x630.png
```

### 制約条件

- 限られた開発リソースと期間
- コア機能（日報作成・送信）の優先実装
- 複雑なSNS連携システムの実装・運用コスト
- 初期運用での実際のバウンス・苦情発生率が不明

# 🎨 対応案

### 案1: SES SNS バウンス・苦情処理システムを実装

**メリット:**

- **自動的なサプレッションリスト管理**: 問題のあるメールアドレスを自動除外
- **リアルタイム監視**: バウンス・苦情の即座な検出と対応
- **SESアカウント保護**: 制限値超過を防ぎ、アカウント停止リスクを最小化
- **配信品質向上**: 問題アドレスの除外により全体の配信成功率が向上
- **運用の自動化**: 手動での問題アドレス管理が不要

**デメリット:**

- **実装コストの増加**: SNS設定、Webhook実装、データベース設計の追加工数（約2-3週間）
- **システム複雑性**: 非同期処理、重複処理防止、エラーハンドリングの複雑化
- **運用負荷**: SNS通知の監視、失敗通知の対応、システム保守
- **初期設定の複雑さ**: Configuration Set、SNS Topic、IAM権限の適切な設定
- **テスト難易度**: バウンス・苦情シナリオの再現テストが困難

### 案2: SES SNS処理システムを実装しない（推奨案）

**メリット:**

- **開発効率**: コア機能の実装に集中可能、開発期間の短縮
- **システムのシンプル性**: 理解しやすく保守しやすい設計
- **初期運用リスクの回避**: 複雑な非同期処理によるバグリスクの排除
- **段階的なリスク評価**: 実際の運用データに基づく必要性の判断が可能

**デメリット:**

- **手動でのリスク管理**: バウンス・苦情率の手動監視が必要
- **SESアカウントリスク**: 制限値超過時のアカウント停止可能性
- **問題アドレスの蓄積**: 無効なメールアドレスへの継続送信
- **運用負荷**: CloudWatch監視とサプレッションリストの手動管理

### 案3: 簡易版監視システムの実装

**メリット:**

- **最小限のリスク対策**: CloudWatch Alarmによる基本的な監視
- **実装コストの抑制**: SNS連携なしでのメトリクス監視のみ

**デメリット:**

- **対応の遅延**: リアルタイム対応ができず事後対応となる
- **自動化の欠如**: 問題発生時の手動対応が必要
- **不完全なソリューション**: 根本的な問題解決には至らない

# 🚀 決定

案2 ==開発チームにおいて==（SES SNS バウンス・苦情処理システムを実装しない）を採用する。

> [!info]
> 
> インフラ83チームにて、現在取り組んでいる監視基盤構築で簡易的に取り組むかどうか検討する

### 決定理由

1. **開発リソースの最適配分**:
    - 限られた開発期間において、コア機能（日報作成・送信・管理）の品質確保を最優先
    - SNS連携システムの実装には2-3週間の追加工数が必要であり、初期リリースの遅延リスク
2. **実際の使用パターンに基づく判断**:
    - 日報送信の対象は主に社内ユーザーと既知の協力会社
    - 無効メールアドレスの比率が一般的なマーケティングメールより低いと予想
    - 実運用開始後の実際のバウンス・苦情率データに基づく適切な対策立案が可能
3. **リスクの許容範囲**:
    - 建設業界の日報という用途では、受信者が限定的で管理可能
    - 初期段階では手動監視とメールアドレス管理で十分対応可能
    - AWS SESの制限値（バウンス率5%、苦情率0.1%）に対する予防的措置は別途実装
4. **段階的な機能拡張戦略**:
    - システムの実際の利用状況と問題発生パターンを把握してから実装
    - より適切で効率的な設計が可能になる

### 採用する代替リスク管理策

#### 1. CloudWatch監視の設定

typescript

```typescript
// CloudWatch Alarmの設定例
const bounceRateAlarm = {
  AlarmName: 'SES-Bounce-Rate-High',
  MetricName: 'Bounce',
  Namespace: 'AWS/SES',
  Statistic: 'Average',
  Threshold: 0.04, // 4%でアラート（制限値5%より低く設定）
  ComparisonOperator: 'GreaterThanThreshold',
  AlarmActions: ['arn:aws:sns:region:account:alert-topic']
};
```

#### 2. 事前のメールアドレス検証強化

typescript

```typescript
// メールアドレスの基本検証強化
function validateEmailAddress(email: string): boolean {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  const isValidFormat = emailRegex.test(email);
  
  // 明らかに無効なドメインの除外
  const invalidDomains = ['test.com', 'example.com', 'invalid.email'];
  const domain = email.split('@')[1]?.toLowerCase();
  const isValidDomain = !invalidDomains.includes(domain);
  
  return isValidFormat && isValidDomain;
}
```

#### 3. 手動サプレッションリスト管理

sql

```sql
-- 問題のあるメールアドレスの管理テーブル
CREATE TABLE email_suppression_list (
  email VARCHAR(100) PRIMARY KEY,
  reason VARCHAR(20) NOT NULL, -- 'bounce', 'complaint', 'manual'
  added_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  added_by UUID,
  notes TEXT
);

-- 送信前チェック
SELECT email FROM email_suppression_list 
WHERE email = ? AND reason IN ('bounce', 'complaint');
```

#### 4. 定期的な手動レビュー

- 週次でのSES送信統計レビュー
- バウンス・苦情率の手動計算と記録
- 問題アドレスの手動特定と除外

# 🪞 結果・影響


### 期待される効果

1. **開発期間の短縮**: SNS連携実装工数（2-3週間）の削減により、コア機能の早期リリース
2. **システム安定性の向上**: 複雑な非同期処理を避けることによる初期運用の安定化
3. **保守コストの削減**: シンプルなシステム構成による運用・保守負荷の軽減
4. **適切な設計判断**: 実際の使用データに基づく将来の機能設計

### 対応すべきリスク・懸念

1. **SESアカウント停止リスク**
    - **懸念**: バウンス・苦情率の超過によるアカウント停止
    - **対策**: CloudWatch監視、手動レビュー、問題アドレスの即座の手動除外
2. **問題の早期発見遅延**
    - **懸念**: バウンス・苦情の検出が遅れ、制限値超過のリスク増加
    - **対策**: 日次でのSES統計確認、閾値を下回る早期警告設定
3. **運用負荷の増加**
    - **懸念**: 手動でのメールアドレス管理とモニタリング作業
    - **対策**: 運用手順書の作成、定期レビューのスケジュール化
4. **スケーラビリティの制約**
    - **懸念**: 送信量増加時の手動管理の限界
    - **対策**: 送信量の定期監視、自動化システム実装の閾値設定


# 🍜 今後の検討事項

以下の条件に該当した場合、このADRの見直しを行う：

1. **制限値への接近**: バウンス率が3%、苦情率が0.05%を超えた場合
2. **送信量の大幅増加**: 月間送信数が10,000通を超えた場合
3. **手動管理の限界**: 週あたりの問題アドレス数が50件を超えた場合
4. **SESからの警告**: AWSから送信品質に関する警告を受けた場合
5. **ビジネス要件の変化**: マーケティングメールなど用途拡大の場合

### 実装スケジュール

- **フェーズ1（現在）**: 基本的なメール送信機能の実装
- **フェーズ2（運用開始後1-3ヶ月）**: CloudWatch監視と手動運用の確立
- **フェーズ3（必要に応じて）**: SNS連携システムの設計・実装


