---
type: note
tags:
- '#ai/ref'
---
# 📜 文脈・背景

工程管理アプリケーションの日報機能において、ガントチャートや進捗率チャートを画像として自動生成し、メール添付する機能の実装が必要となった。この機能は以下の要件を満たす必要がある：

- **機能要件**: ユーザーが日報作成時に「工程表を添付する」ボタンをクリックすると、現在表示されているガントチャートを画像として生成し、S3にアップロードして添付ファイルとして管理する
- **品質要件**: 生成される画像は印刷やメール共有に適した高品質である必要がある
- **精度要件**: 工程項目とチャート要素の位置関係が正確に保持される必要がある

技術的背景として、フロントエンド（Next.js + TypeScript）でDOMエレメントを画像に変換する必要があり、ブラウザ環境で動作するライブラリが必要であった。

既存の技術選択肢として以下が検討対象となった：

- **html2canvas**: 最も広く使用されているDOM to Image ライブラリ
- **dom-to-image**: html2canvasの軽量代替案として人気のライブラリ
- **modern-screenshot**: 新しいライブラリで高性能を謳うもの
- **Canvas API手動描画**: チャートライブラリの描画機能を直接利用
- **サーバーサイド画像生成**: Puppeteer等を使用したサーバーサイド処理

プロジェクト制約として、現在はベータ版リリース前の段階であり、機能実装の速度と安定性を重視する必要がある。

# 🎨 対応案

## 1. html2canvas

**採用理由**:

- 最も実績があり、コミュニティサポートが充実
- 豊富なドキュメントと事例
- 複雑なCSS対応

**懸念点**:

- バンドルサイズが比較的大きい
- 一部レンダリング精度の問題

## 2. dom-to-image

**採用理由**:

- 軽量でパフォーマンスが良好
- SVG処理が優秀
- TypeScript対応

**懸念点**:

- html2canvasと比較してコミュニティが小さい
- 一部ブラウザ互換性の制限

## 3. modern-screenshot

**採用理由**:

- 最新技術による高性能
- 小さなバンドルサイズ

**懸念点**:

- 新しいライブラリで実績が少ない
- 長期サポートの不透明さ

## 4. その他の選択肢

**Canvas API手動描画**: 実装コストが高く、開発期間に制約がある現状では非現実的 **サーバーサイド生成**: アーキテクチャの複雑化とレスポンス時間の悪化を招く

# 🚀 決定

**工程管理アプリケーションの画像生成機能において、dom-to-imageライブラリを採用する。**

この決定は以下の検証結果に基づく：

1. **実装検証**: html2canvasとdom-to-imageの両方で実装を試行した結果、html2canvasでは工程項目とチャート要素の位置にずれが生じることが確認された
	↓html2canvas
	![[8a4e0ab8-0fb2-4924-bd48-46fcaa1de6a6.png]]
	↓dom-to-image
	![[db1785a0-cebb-49e4-8839-e97ec3e621b5.png]]
2. **品質優先**: 工程管理という業務の性質上、ガントチャートの正確性は極めて重要であり、位置ずれは実用上致命的な問題となる
    
3. **パフォーマンス**: dom-to-imageの方が軽量で、Webアプリケーションのパフォーマンスに与える影響が小さい
    
4. **技術適合性**: TypeScript環境での開発に適しており、既存の技術スタックとの親和性が高い
    

実装方針として、以下を採用する：

- 画像品質は0.95に設定し、高品質を保持する
- 背景色を明示的に白色（#ffffff）に設定する
- スケール変換による高解像度対応を実装する

# 🪞 結果・影響

## プラスの結果

1. **品質向上**: 工程項目とチャート要素の位置関係が正確に保持され、実用的な画像が生成可能
2. **パフォーマンス向上**: 軽量なライブラリにより、アプリケーションの応答性が向上
3. **開発効率**: TypeScript対応により、型安全性が確保され開発効率が向上
4. **バンドルサイズ削減**: html2canvasと比較してより小さなバンドルサイズを実現

## 中立的な結果

1. **学習コスト**: 開発チームがdom-to-imageの特性を理解する必要がある
2. **エラーハンドリング**: html2canvasとは異なるエラーパターンへの対応が必要

## マイナスの結果

1. **コミュニティサイズ**: html2canvasと比較してコミュニティが小さく、トラブルシューティング時の情報が限定的
2. **ブラウザ互換性**: 一部古いブラウザでの動作に制限がある可能性
3. **機能制限**: html2canvasの一部高度な機能が利用できない場合がある

## 連鎖的影響

1. **依存関係管理**: package.jsonにdom-to-imageを追加し、継続的なアップデート管理が必要
2. **テスト戦略**: 画像生成機能のテストケース作成において、dom-to-image特有の考慮事項への対応
3. **デプロイメント**: 画像生成機能のパフォーマンス監視とメトリクス収集の実装

# 🍜 今後の検討事項

1. **パフォーマンス監視**: 本番環境での画像生成速度とメモリ使用量の継続的な監視体制の構築
    
2. **エラーハンドリング強化**: 画像生成失敗時のフォールバック機能（代替画像、リトライ機能等）の実装検討
    
3. **ブラウザ互換性テスト**: サポート対象ブラウザでの包括的な動作テストの実施
    
4. **画像品質最適化**: ファイルサイズと画質のバランス調整、圧縮アルゴリズムの最適化検討
    
5. **代替案の継続評価**: modern-screenshotなど新しいライブラリの成熟度監視と、将来的な移行可能性の評価
    
6. **キャッシュ戦略**: 同一チャートの重複生成を避けるためのキャッシュ機能の実装検討
    
7. **セキュリティ対策**: 将来的なセキュリティ要件強化時における、画像内のPII情報マスキング機能の統合検討
    
8. **スケーラビリティ**: ユーザー数増加時の画像生成負荷分散、サーバーサイド生成への移行可能性の評価
    

---

## 参考資料

- [dom-to-image GitHub Repository](https://github.com/tsayen/dom-to-image)
- [html2canvas公式ドキュメント](https://html2canvas.hertzen.com/)
- 工程管理アプリケーション機能要件書
- 日報機能設計書


