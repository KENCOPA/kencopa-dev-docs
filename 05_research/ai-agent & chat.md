---
type: note
tags:
- '#ai/ref'
---
> [!info] å¿…è¦ãªã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼

# ğŸ¯ ç›®çš„ãƒ»å¯¾è±¡ç¯„å›²

- **ç›®çš„**
  Â  - AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®AWSã§ã®å®Ÿè£…æ–¹é‡ã‚’æ˜ç¢ºã«ã™ã‚‹
- **å¯¾è±¡ç¯„å›²** 
  Â  - 2025å¹´7æœˆã®è£½å“ç‰ˆå…¬é–‹ã«å‘ã‘ãŸè¨­è¨ˆ

> [!info] 
> ç¾æ™‚ç‚¹ï¼ˆ2025å¹´4æœˆæ™‚ç‚¹ï¼‰ã§ã¯ç”»åƒãªã©ãƒ†ã‚­ã‚¹ãƒˆä»¥å¤–ã®æ‰±ã„ã‚’ã©ã†ã™ã‚‹ã‹ã¯è¨­è¨ˆã®å¯¾è±¡å¤–ã¨ã—ã¦ã„ã‚‹ã€‚

# ğŸ— ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆæ¦‚è¦

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³
- [[ğŸ—’ï¸ ai-agent & chat AWSå…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ï¼ˆMermaidï¼‰]]
## ADR
- [[ğŸ—’ï¸ 000001-AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã‚’ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹åŒ–]]
- [[ğŸ—’ï¸ 000002-ai-agentã®ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–ã«Redisã‚’ä½¿ç”¨]]
- [[ğŸ—’ï¸ 000003-ai-agentã®ãƒ­ãƒƒã‚¯æ©Ÿæ§‹ã«Redisã‚’ä½¿ç”¨]]
# ğŸ›  åŸºæœ¬è¨­è¨ˆ
## [azuchi-chat] Web Socket ãƒ«ãƒ¼ãƒˆè¨­è¨ˆ
### $connect
**æ¦‚è¦**
- web socketæ¥ç¶šã«ä½¿ç”¨ã™ã‚‹ãƒ«ãƒ¼ãƒˆã€‚

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼**
- sessionId: String | undefined

**å‡¦ç†æ‰‹é †**
- eventã‹ã‚‰connectionIdã‚’å–å¾—ã™ã‚‹
- sessionIdãŒundefinedã®å ´åˆ
	- sessionIdã‚’æ¡ç•ªã™ã‚‹ï¼ˆUUIDï¼‰
	- sessionsãƒ†ãƒ¼ãƒ–ãƒ«ã«sessionIdã‚’æ›¸ãè¾¼ã‚€
- connectionsãƒ†ãƒ¼ãƒ–ãƒ«ã«connectionIdã‚’æ›¸ãè¾¼ã‚€
### $disconnect
**æ¦‚è¦**
- web socketæ¥ç¶šçµ‚äº†æ™‚ã«ä½¿ç”¨ã™ã‚‹ãƒ«ãƒ¼ãƒˆ
**å‡¦ç†æ‰‹é †**
- eventã‹ã‚‰connectionIdã‚’å–å¾—ã™ã‚‹
- connectionsãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰connectionIdã‚’å‰Šé™¤ã™ã‚‹

### $default
**æ¦‚è¦**
- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã«ä½¿ç”¨ã•ã‚Œã‚‹ãƒ«ãƒ¼ãƒˆ
**å‡¦ç†æ‰‹é †**
- ä½¿ç”¨å¯èƒ½ãªãƒ«ãƒ¼ãƒˆã®ä¸€è¦§ã‚’è¿”ã™

### putMessage
**æ¦‚è¦**
ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä½œæˆæ™‚ã«ä½¿ç”¨ã™ã‚‹ãƒ«ãƒ¼ãƒˆ
**å‡¦ç†æ‰‹é †**
- å¿…è¦ãªæƒ…å ±ã‚’eventã‹ã‚‰å–å¾—ã™ã‚‹
- ai-agentã‚’èµ·å‹•ã™ã‚‹
- messagesãƒ†ãƒ¼ãƒ–ãƒ«ã«æ›¸ãè¾¼ã‚€

## [azuchi-chat] Dynamoãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ

### sessions
ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç®¡ç†ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã€‚`$connect`ã§æ›¸ãè¾¼ã‚€ã€‚

|               | key       | value  | description     | example                              |
| ------------- | --------- | ------ | --------------- | ------------------------------------ |
| partition key | sessionId | String | ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§æ¡ç•ªã•ã‚Œã‚‹å€¤ | 11756791-ed89-4197-bb09-b096be95412e |
|               | title     | String | ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚¿ã‚¤ãƒˆãƒ«      | xxxã‚’yyyã™ã‚‹æ–¹æ³•                          |

### connections
web socketã®ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’ç®¡ç†ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã€‚`$connect`ã§æ›¸ãè¾¼ã¿ã€$disconectã§å‰Šé™¤ã€‚

|                        | key          | type   | description                      | example                              |
| ---------------------- | ------------ | ------ | -------------------------------- | ------------------------------------ |
| partition  key         | connectionId | String | Web Socketæ¥ç¶šæ™‚ã«API Gatewayã§æ¡ç•ªã•ã‚Œã‚‹å€¤ | H0zlrcJgtjMCEHA=                     |
|                        | sessionId    | String | ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§æ¡ç•ªã•ã‚Œã‚‹å€¤                  | 11756791-ed89-4197-bb09-b096be95412e |
| Global Secondary Index | userId       | String |                                  |                                      |

### messages
ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç®¡ç†ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã€‚`putMessage`ã§æ›¸ãè¾¼ã‚€ã€‚

|               | key          | value  | description                                | example                              |
| ------------- | ------------ | ------ | ------------------------------------------ | ------------------------------------ |
| partition key | sessionId    | String | ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§æ¡ç•ªã•ã‚Œã‚‹å€¤                            | 11756791-ed89-4197-bb09-b096be95412e |
| sort key      | createdAt    | Number | ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä½œæˆã•ã‚ŒãŸæ™‚é–“                               | 1740705881                           |
|               | connectionId |        |                                            |                                      |
|               | role         | String | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ç¨®åˆ¥ï¼ˆUSER / AGENT / SYSTEMï¼‰ | USER                                 |
|               | message      | String | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æœ¬æ–‡                                   | ã“ã‚“ã«ã¡ã‚ï¼ï¼                              |
|               | messageType  | String | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç¨®åˆ¥ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ä¸‹ã®æƒ…å ±ã‚’å‚ç…§ï¼‰                      | CONVERSATION                         |
**messageTypeä¸€è¦§**
> [!information] æš«å®šãªã®ã§é©å®œè¿½åŠ ã™ã‚‹
> EXCELã¨ã‹WORK_ORDER_PREVIEWã¨ã‹OUTPUTã«å¿œã˜ãŸmessageTypeãŒå¢—ãˆã¦ã„ããã†

- CONVERSATION: ä¼šè©±ï¼ˆex. ä»Šæ—¥ã¯ä½•ã®ãŠæ‰‹ä¼ã„ã‚’ã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿï¼‰
- PLAN: Agentã®å®Ÿè¡Œè¨ˆç”»
- SYSTEM_LOG: ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè¡Œãƒ­ã‚°ï¼ˆex. æ¥ç¶šä¸­ã§ã™ï¼‰
- AGENT_LOG: Agentã®å®Ÿè¡Œãƒ­ã‚°ï¼ˆex. xxxã‚’å®Ÿæ–½ã—ã¾ã—ãŸï¼‰

## [azuchi-ai-agent] API Gateway APIè¨­è¨ˆ

### generateChatReply
**æ¦‚è¦**
- ãƒãƒ£ãƒƒãƒˆã®è¿”ä¿¡ã‚’ç”Ÿæˆã™ã‚‹

**ãƒ‘ã‚¹**
- POST: api/v1/chat/sessions/{sessionId}/reply/generate

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼**
- sessionIdï¼ˆPathï¼‰: String
- messageï¼ˆBodyï¼‰: String

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**
ãªã—
## [azuchi-ai-agent] ElasticCache ã‚­ãƒ¼è¨­è¨ˆ
### ã‚­ãƒ¼ã®å‘½åè¦å‰‡
- `<app_prefix>`ï¼šã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åï¼ˆä¾‹ï¼šazuchiï¼‰
- `<service_domain_prefix>`ï¼šã‚µãƒ¼ãƒ“ã‚¹ãƒ‰ãƒ¡ã‚¤ãƒ³åï¼ˆä¾‹ï¼šai-agentï¼‰
- `<category>`ï¼šå¤§åˆ†é¡ï¼ˆä¾‹ï¼šlockï¼sessionï¼‰
- `<session_id>`ï¼šUUIDãªã©ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³è­˜åˆ¥å­
- `<sub_key>`ï¼šsession é…ä¸‹ã®æ›´ã«ç´°ã‹ã„ç”¨é€”ï¼ˆä¾‹ï¼šhistoryï¼memoryï¼‰
```
<app_prefix>:<category>:<session_id>[:<sub_key>]
```
### ãƒ­ãƒƒã‚¯ç”¨ã‚­ãƒ¼
| **ç”¨é€”**   | **ã‚­ãƒ¼ä¾‹**                                     | **å‹**  | **æ“ä½œ**                                        | **TTL**  |
| -------- | ------------------------------------------- | ------ | --------------------------------------------- | -------- |
| ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ­ãƒƒã‚¯ | azuchi:ai-agent:lock:session:{{session_id}} | String | SET key value NX PX 30000Luaã‚¹ã‚¯ãƒªãƒ—ãƒˆã§æ‰€æœ‰è€…ãƒã‚§ãƒƒã‚¯ï¼‹DEL | 30ç§’ (PX) |

### ä¼šè©±å±¥æ­´ç”¨ã‚­ãƒ¼
| **ç”¨é€”**       | **ã‚­ãƒ¼ä¾‹**                                        | **å‹** | **æ“ä½œä¾‹**                                  | **TTL** |
| ------------ | ---------------------------------------------- | ----- | ---------------------------------------- | ------- |
| æœ€æ–° N ä»¶ãƒãƒ£ãƒƒãƒˆå±¥æ­´ | azuchi:ai-agent:session:{{session_id}}:history | List  | - LPUSH key <JSONãƒ¡ãƒƒã‚»ãƒ¼ã‚¸>- LTRIM key 0 N-1 | ãªã—      |

### ä¼šè©±å±¥æ­´IDç”¨ã‚­ãƒ¼
openai agent SDKã§ä½¿ç”¨ã§ãã‚‹previous_response_idã‚’ä¿æŒã—ã¦ãŠãã‚­ãƒ¼ã€‚

| **ç”¨é€”**                  | **ã‚­ãƒ¼ä¾‹**                                                     | **å‹**  | **æ“ä½œä¾‹**                         | **TTL** |
| ----------------------- | ----------------------------------------------------------- | ------ | ------------------------------- | ------- |
| previous_response_idã®ä¿æŒ | azuchi:ai-agent:session:{{session_id}}:previous_response_id | String | SET key resp_789 EX 1728000<br> | 20æ—¥     |
