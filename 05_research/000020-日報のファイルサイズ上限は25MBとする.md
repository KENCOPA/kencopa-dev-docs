---
type: note
moc: "[[🏷️ADR]]"
tags:
- '#ai/ref'
---
## 📜 文脈・背景

日報メール送信機能において、添付ファイルのサイズ制限を決定する必要がある。

### AWS SES v2の技術的制約

- AWS SES v2 APIの最大メールサイズ制限は40MB
- この制限は以下の全てを含む総サイズ：
    - メール本文（件名、内容）
    - メールヘッダー（From、To、CC、Subject等）
    - 添付ファイル
    - **MIMEエンコーディング後のサイズ**

### MIMEエンコーディングによるサイズ増加

Base64エンコーディングにより、添付ファイルは元サイズの約137%に増加する：

- Base64エンコーディング: +33.33%（3バイト→4文字変換）
- MIME改行コード: +2.63%（76文字毎のCRLF追加）
- 合計: 約137%（元サイズ × 1.37）

**技術的根拠：**

- [AWS SES公式ドキュメント](https://docs.aws.amazon.com/ses/latest/dg/manage-sending-quotas.html)
	- 5MBファイルは約6.85MB（137%）になる
- [Wikipedia - Base64](https://en.wikipedia.org/wiki/Base64)
	- MIME準拠Base64エンコードデータは通常、元データの約137%
- [Cisco公式ドキュメント]
	- base64エンコードデータの最終サイズ = 元サイズ × 1.37 + 814バイト（ヘッダー）

### 現場の業務要件

- 工事現場で撮影した写真：通常2-10MB
- 工程表・進捗チャートの画像出力：通常1-5MB
- PDF資料（安全パトロール報告書等）：通常1-20MB
- 複数ファイルの同時添付需要

### 既存システムの制約

- ITに慣れていない現場作業者が主要ユーザー
- 直感的でわかりやすいファイルサイズ制限が必要
- メール送信失敗によるビジネスインパクトの回避が重要

## 🎨 対応案

### 案1: 元ファイルサイズで25MB制限

- メリット：ユーザーにとって直感的、現場要件をカバー
- デメリット：MIMEエンコーディング後の制限チェックが別途必要

### 案2: 元ファイルサイズで30MB制限

- メリット：より多くのファイルを添付可能
- デメリット：安全マージンが少なく、送信失敗リスクが高い

### 案3: エンコード後サイズで40MB制限表示

- メリット：技術的に正確
- デメリット：ユーザーの混乱、UX悪化

## 🚀 決定

日報添付ファイルの**元ファイルサイズ**の上限を**25MB**に設定する。

### 実装仕様

1. **フロントエンド・バックエンド検証**：`file.size`プロパティを使用して25MB制限をチェックする
	1. バックエンドはより詳細な検証が可能だが(1.37倍にするなど）、現時点では行わない
2. **制限値の計算根拠**：`40MB ÷ 1.37 - 4.2MB（マージン） = 25MB`

### 技術的実装方針

- ユーザー表示は分かりやすい元ファイルサイズを使用
- 内部的にはMIMEエンコーディングを考慮した二重チェック体制
- 保守的なアプローチにより送信成功率を最大化

## 🪞 結果・影響

### プラスの結果

- **送信成功率の向上**：SES制限超過によるメール送信失敗を防止
- **ユーザビリティの向上**：元ファイルサイズによる直感的な理解
- **現場要件の充足**：一般的な工事現場ファイル（写真、PDF、工程表）を網羅
- **安全マージンの確保**：メール本文やヘッダーサイズの変動を吸収

### マイナスの結果

- **大容量ファイル排除**：一部の大容量PDF等が直接添付不可

### 中立的な影響

- **代替手段の提供**：S3クラウドストレージリンク機能の必要性
- **将来拡張性**：制限値は設定により調整可能
- **教育コスト**：現場ユーザーへのファイルサイズ最適化指導

### 後続ADRへの影響

- ファイル圧縮機能の実装検討が必要
- エラーハンドリング戦略の詳細化が必要

## 🍜 今後の検討事項

### 短期的検討事項（1-3ヶ月）

- ファイル圧縮アルゴリズムの導入検討
- リンク共有機能の詳細設計

### 中期的検討事項（3-6ヶ月）

- 制限値の実運用データに基づく見直し
- ファイル種別ごとの最適化戦略（JPEG圧縮、PDF最適化等）
- プログレッシブアップロード機能の検討

### 長期的検討事項（6ヶ月以上）

- AWS SES制限変更への対応戦略
- 動画ファイル添付需要への対応
- マルチクラウド対応によるベンダーロックイン回避

### 監視・レビュー項目

- メール送信失敗率（目標：1%未満）
- ファイルサイズ制限によるユーザー離脱率
- 代替手段（S3リンク）の利用率
- 3ヶ月後の制限値適切性レビュー


