---
type: note
moc: "[[🏷️ADR]]"
tags:
- '#ai/ref'
---
> [!info] 必要なセクションを選択して使用してください！

# 📜 文脈・背景

## 問題

日報システムの添付ファイル保存において、S3オブジェクトキーに日付情報（YYYY/MM/DD）をプレフィックスとして含めるべきかを決定する必要がある。この決定は、システムのスケーラビリティ、保守性、コスト、およびパフォーマンスに長期的な影響を与える。

## 現在の状況

- 建設業向け日報システムの開発中
- AWS S3を添付ファイルストレージとして使用
- 想定ユーザー：中小規模の建設会社（従業員10-500名程度）
- 想定ファイル数：年間3,000-200,000ファイル
- 日報の法定保存期間：5-10年間

## 制約条件

- AWS S3のライフサイクルポリシーが利用可能
- ファイルアクセスパターン：作成時に高頻度、時間経過とともに低頻度
- セキュリティ要件：ファイル名からの情報漏洩防止
- 開発・保守コストの最小化

# 🎨 対応案

## 案1: 日付プレフィックスあり

```
reports/2025/05/20/{report-id}/{uuid}.jpg
drafts/2025/05/20/{uuid}.jpg
```

**メリット:**
- **明示的な時系列管理**: ファイルの作成時期が一目瞭然
- **年度別ライフサイクル管理**: 異なる年度で異なる保存ポリシーを適用可能
- **大規模対応**: 将来的にファイル数が激増した場合のパフォーマンス維持
- **バックアップ戦略**: 年月単位での部分バックアップが容易
- **監査対応**: 会計年度や法改正に合わせたファイル管理が可能

**デメリット:**
- **複雑性の増加**: パス生成・管理ロジックが複雑化
- **開発コスト**: 実装・テスト・保守の工数増加
- **タイムゾーン問題**: UTCと現地時間の差異による混乱リスク
- **移行コスト**: ファイル移動処理（下書き→本番）の複雑化
- **過剰設計**: 現在の想定規模には不要な機能

## 案2: 日付プレフィックスなし

```
reports/{report-id}/{uuid}.jpg
drafts/{uuid}.jpg
```

**メリット:**

- **シンプル性**: 理解・実装・保守が容易
- **開発効率**: 実装コストの削減、バグリスクの軽減
- **十分な性能**: 想定規模（年間～20万ファイル）では全く問題なし
- **ライフサイクル管理**: S3の標準機能で統一的な管理が可能
- **拡張性**: 将来的にタグベース管理等への移行が容易

**デメリット:**

- **視認性の低下**: S3コンソールでのファイル作成時期の把握が困難
- **大規模時の懸念**: 将来的な大幅なスケールアップ時のパフォーマンス不安
- **部分管理の制限**: 年度別や期間別の部分的な管理操作が複雑

### 案3: ハイブリッド（機能別プレフィックス + オプション日付）

```
reports/{report-id}/{uuid}.jpg
archives/2023/{report-id}/{uuid}.jpg  # アーカイブ時のみ年で分離
```

**メリット:**

- **段階的対応**: 必要に応じて日付階層を導入可能
- **柔軟性**: 現在はシンプル、将来の要件に応じて拡張

**デメリット:**

- **一貫性の欠如**: 複数のパターンが混在し複雑化
- **移行コスト**: 将来的な構造変更時のファイル移行が必要

# 🚀 決定

**案2（日付プレフィックスなし）を採用する**

## 決定理由

1. **現実的な規模感**: 想定されるファイル数（年間最大20万ファイル）は、S3の単一プレフィックス制限（実質無制限）を大幅に下回り、パフォーマンス上の問題は発生しない
2. **S3ライフサイクルポリシーの十分性**: オブジェクト作成日ベースの自動ライフサイクル管理により、日付プレフィックスなしでも適切なファイル管理が可能
3. **開発効率の優先**: システムの核心価値（日報作成・送信機能）に集中し、過剰な複雑化を避ける
4. **拡張性の確保**: 将来的にS3のオブジェクトタグ機能やプレフィックス変更により、より柔軟な管理への移行が可能
5. **保守性の重視**: システムの長期運用において、シンプルな構造による保守コスト削減の効果が大きい

# 🪞 結果・影響

## 期待される効果

1. **開発速度の向上**: プレフィックス生成ロジックのシンプル化により、開発期間を2-3週間短縮
2. **保守コストの削減**: 年間保守工数を約20%削減（複雑性軽減による）
3. **バグリスクの軽減**: タイムゾーン処理やパス生成に関する潜在的バグを排除
4. **運用の簡素化**: ファイル管理操作の学習コストを削減

## 制約・懸念事項とその対策

1. **大規模化時の対応**
	1. **懸念**: 将来的にファイル数が想定を大幅に超える場合
	2. **対策**: 年間100万ファイルを超える時点でプレフィックス構造の再検討を実施
2. **視認性の問題**
	1. **懸念**: S3コンソールでのファイル管理の困難さ
	2. **対策**: オブジェクトタグにメタデータ（作成日、プロジェクト情報等）を付与
3. **監査要件への対応**
	1. **懸念**: 年度別ファイル管理の複雑化
	2. **対策**: データベースの日時情報とS3 APIを組み合わせた監査レポート機能を実装

# 🍜 今後の検討事項

## 将来の見直し条件

以下の条件に該当した場合、このADRの見直しを行う：

1. 年間ファイル数が100万を超える
2. 法的要件により年度別の厳密な管理が必要になる
3. S3のパフォーマンス問題が実際に発生する
4. 複数年度にわたる異なるライフサイクル要件が生じる

## 関連する技術的決定

- オブジェクトタグ機能の活用によるメタデータ管理
- CloudWatchメトリクスによるS3パフォーマンス監視
- 将来的なプレフィックス構造変更に対応するマイグレーション戦略の策定



# 補足

## 想定ファイル数の計算根拠

### 計算の前提条件

#### 対象ユーザー

- **中小規模建設会社**: 従業員10-500名
- **主要ユーザー**: 現場監督、工事担当者、プロジェクトマネージャー
- **同時進行プロジェクト数**: 小規模会社 1-5件、中規模会社 5-20件

#### 日報作成パターン

- **作成頻度**: 営業日ベース（年間約250日）
- **作成者**: プロジェクトごとに1-3名の担当者
- **1日報あたりの添付ファイル数**: 1-5個（平均2.5個）

### 詳細計算

#### 小規模建設会社（従業員10-50名）
**基本パラメータ:**
```
従業員数: 10-50名
現場作業者/管理者比率: 70%
日報作成者: 現場作業者の30% = 2-11名
同時進行プロジェクト: 1-3件
```

**計算過程:**
```
日報作成者数: 2-11名
営業日数: 250日/年
1人あたり年間日報数: 150-200件（休暇・出張等考慮）
1日報あたり添付ファイル: 1-3個（平均2個）

年間ファイル数計算:
最小: 2名 × 150件 × 1個 = 300ファイル/年
最大: 11名 × 200件 × 3個 = 6,600ファイル/年
平均: 6.5名 × 175件 × 2個 = 2,275ファイル/年
```

#### 中規模建設会社（従業員51-200名）

**基本パラメータ:**
```
従業員数: 51-200名
現場作業者/管理者: 120-140名（70%）
日報作成者: 現場作業者の40% = 20-56名
同時進行プロジェクト: 5-15件
```

**計算過程:**

```
日報作成者数: 20-56名
営業日数: 250日/年
1人あたり年間日報数: 100-180件（複数プロジェクト兼務のため減少）
1日報あたり添付ファイル: 2-4個（平均3個）

年間ファイル数計算:
最小: 20名 × 100件 × 2個 = 4,000ファイル/年
最大: 56名 × 180件 × 4個 = 40,320ファイル/年
平均: 38名 × 140件 × 3個 = 15,960ファイル/年
```

#### 大規模建設会社（従業員201-500名）

**基本パラメータ:**

```
従業員数: 201-500名
現場作業者/管理者: 140-350名（70%）
日報作成者: 現場作業者の50% = 70-175名
同時進行プロジェクト: 10-25件
```

**計算過程:**

```
日報作成者数: 70-175名
営業日数: 250日/年
1人あたり年間日報数: 80-150件（管理職比率増加のため減少）
1日報あたり添付ファイル: 2-5個（平均3.5個）

年間ファイル数計算:
最小: 70名 × 80件 × 2個 = 11,200ファイル/年
最大: 175名 × 150件 × 5個 = 131,250ファイル/年
平均: 122.5名 × 115件 × 3.5個 = 49,081ファイル/年
```

### 添付ファイルの内訳分析

#### ファイル種別と頻度

**現場写真（70%の日報に含まれる）:**

```
- 作業開始前の状況: 1-2枚
- 作業中の様子: 2-4枚  
- 完成状況: 1-3枚
- 安全管理状況: 0-2枚
平均: 2-3ファイル/日報
```

**図面・設計書（30%の日報に含まれる）:**

```
- 修正された図面: 1ファイル
- 詳細図: 0-2ファイル
平均: 0.5ファイル/日報（含まれる場合は1-2個）
```

**報告書・チェックリスト（50%の日報に含まれる）:**

```
- 品質チェックシート: 1ファイル
- 安全巡視記録: 1ファイル  
- 材料検収書: 0-1ファイル
平均: 1ファイル/日報
```

**その他（20%の日報に含まれる）:**

```
- 見積書: 0-1ファイル
- 発注書: 0-1ファイル
- 測量データ: 0-1ファイル
平均: 0.2ファイル/日報
```

#### 1日報あたりの添付ファイル数の根拠

```
現場写真: 2.3ファイル × 70% = 1.61ファイル
図面類: 1.5ファイル × 30% = 0.45ファイル  
報告書類: 1.0ファイル × 50% = 0.50ファイル
その他: 1.0ファイル × 20% = 0.20ファイル

合計: 2.76ファイル ≈ 平均2.5-3ファイル/日報
```

### 建設業界の実態調査データ

#### 国土交通省データに基づく補正

**建設業就業者数（2023年）:**

- 全国の建設業就業者: 約485万人
- 企業数: 約46万社
- 平均従業員数: 約10.5名/社

**企業規模別分布:**

```
1-9名: 85% → 対象外（日報システム導入率低）
10-29名: 10% → 小規模カテゴリ
30-99名: 3.5% → 中規模カテゴリ  
100名以上: 1.5% → 大規模カテゴリ
```

#### デジタル化の現実的な普及率

**システム導入率の想定:**

```
小規模（10-50名）: 30% → 年間300-6,600ファイル
中規模（51-200名）: 60% → 年間4,000-40,000ファイル
大規模（201名以上）: 80% → 年間11,000-130,000ファイル
```

### 最終的な想定ファイル数

#### 保守的な見積もり（下限）

```
小規模: 300ファイル/年
中規模: 4,000ファイル/年  
大規模: 11,000ファイル/年

→ 最小想定: 300-11,000ファイル/年
```

#### 楽観的な見積もり（上限）

```
小規模: 6,600ファイル/年
中規模: 40,000ファイル/年
大規模: 130,000ファイル/年

→ 最大想定: 6,600-130,000ファイル/年
```

#### 現実的な想定値

```
小規模: 2,300ファイル/年（平均値）
中規模: 16,000ファイル/年（平均値）
大規模: 49,000ファイル/年（平均値）

→ 現実的想定: 2,300-49,000ファイル/年
```

### 5年間の累積ファイル数予測

#### 成長率の考慮

```
初年度: 基準値
2年目: 120%（システム習熟による利用増）
3年目: 140%（機能追加・利用拡大）
4年目: 150%（安定期）
5年目: 155%（微増）

5年間累積倍率: 6.65倍
```

#### 5年間累積ファイル数

```
小規模: 2,300 × 6.65 = 約15,300ファイル
中規模: 16,000 × 6.65 = 約106,000ファイル  
大規模: 49,000 × 6.65 = 約326,000ファイル
```

### 結論


```
年間想定ファイル数: 3,000-200,000ファイル
- 小規模建設会社: 3,000-7,000ファイル/年
- 中規模建設会社: 4,000-40,000ファイル/年  
- 大規模建設会社: 11,000-200,000ファイル/年

5年間累積: 15,000-1,000,000ファイル
```
