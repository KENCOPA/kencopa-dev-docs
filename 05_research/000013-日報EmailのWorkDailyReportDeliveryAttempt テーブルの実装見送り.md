---
type: note
tags:
- '#ai/ref'
---
> [!info] 必要なセクションを選択して使用してください！

# 📜 文脈・背景
## 問題

日報メール送信機能において、各メール送信の詳細な試行履歴（送信時刻、エラーコード、リトライ回数、処理時間など）を記録するための `WorkDailyReportDeliveryAttempt` テーブルの実装を検討している。この決定は、システムの複雑性、開発コスト、および実際の運用要件に影響を与える。
refs: 
- [[🗒️ 日報#データモデル]]

## 現在の状況

- 日報メール送信システムの開発中
- `WorkDailyReportRecipientDetail` テーブルで基本的な送信状態は管理済み
- リトライ機能の実装は予定している
- 監視システムとログ基盤の整備を並行して進行中

## 制約条件

- 限られた開発リソースと期間
- システムの保守性とシンプル性の重視
- 現実的な運用要件への対応
- 将来の拡張性の確保

# 🎨 対応案

## 案1: WorkDailyReportDeliveryAttempt テーブルを実装

**メリット:**

- **詳細な監査証跡**: 各送信試行の完全な履歴を保持
- **高度な分析機能**: 送信パフォーマンス、エラーパターンの詳細分析が可能
- **トラブルシューティング**: 送信失敗の根本原因を詳細に追跡可能
- **リアルタイム監視**: 送信進捗の詳細な可視化
- **将来の最適化**: 蓄積されたデータに基づく送信戦略の改善

**デメリット:**

- **実装コストの増加**: 追加テーブル、API、処理ロジックの実装が必要
- **システム複雑性**: データモデルとビジネスロジックの複雑化
- **パフォーマンス影響**: 各送信試行でのDB書き込みによるオーバーヘッド
- **ストレージコスト**: 大量の履歴データの蓄積
- **保守負荷**: 追加されたテーブルの管理とメンテナンス

### 案2: WorkDailyReportDeliveryAttempt テーブルを実装しない

**メリット:**

- **開発効率**: コア機能の実装に集中可能
- **システムのシンプル性**: 理解しやすく保守しやすい設計
- **十分な基本機能**: `WorkDailyReportRecipientDetail` で必要最小限の情報は管理
- **代替手段の活用**: ログとモニタリングツールで十分な情報を取得可能
- **拡張性**: 将来必要になった時点で段階的に追加可能

**デメリット:**

- **詳細履歴の欠如**: 各試行の詳細な記録がデータベースに残らない
- **分析の制限**: 高度なパフォーマンス分析が困難
- **トラブルシューティングの複雑化**: ログファイルからの情報収集が必要

### 案3: 簡易版の実装（最小限のフィールドのみ）

**メリット:**

- **バランスの取れたアプローチ**: 基本的な情報は記録しつつコストを抑制
- **段階的拡張**: 必要に応じて後から詳細フィールドを追加

**デメリット:**

- **中途半端な機能**: フル実装と比較して恩恵が限定的
- **将来の拡張コスト**: 結局フル実装が必要になるリスク
- **設計の一貫性**: どこまで記録するかの判断基準があいまい

# 🚀 決定

**案2（WorkDailyReportDeliveryAttempt テーブルを実装しない）を採用する**

## 決定理由

1. **現実的な運用要件の充足**:
    - `WorkDailyReportRecipientDetail` テーブルで送信結果、エラーメッセージ、試行回数などの必要最小限の情報は記録される
    - 日報送信の成功・失敗の把握という主要な要件は満たされる
2. **代替手段の十分性**:
    - アプリケーションログで各送信試行の詳細（時刻、エラー、処理時間）を記録
    - AWS CloudWatch Logs による集中ログ管理とクエリ機能
    - モニタリングシステム（CloudWatch Alarms、SNS通知）による異常検知
3. **開発リソースの最適配分**:
    - 限られた開発期間において、コア機能（日報作成・送信・管理）の品質向上に注力
    - 過度な複雑化による品質リスクの回避
4. **保守性とシンプル性の優先**:
    - データモデルの理解しやすさと長期保守性の確保
    - 新しい開発者のオンボーディングコストの削減
5. **段階的拡張戦略**:
    - 実際の運用開始後、具体的な監視・分析ニーズが明確になった時点での実装検討
    - 現在の設計で将来的な拡張は技術的に可能

### 採用する代替手段

#### ログベースの監視

typescript

```typescript
// 詳細な送信ログの出力
logger.info('Email sending attempt', {
  reportId,
  recipientEmail,
  attemptNumber,
  timestamp: new Date().toISOString(),
  result: 'success|failure',
  errorCode,
  errorMessage,
  durationMs,
  sesMessageId
});
```

#### モニタリングとアラート

typescript

```typescript
// CloudWatch カスタムメトリクス
await cloudwatch.putMetricData({
  Namespace: 'DailyReport/Email',
  MetricData: [
    {
      MetricName: 'SendingFailureRate',
      Value: failureCount / totalCount,
      Unit: 'Percent'
    },
    {
      MetricName: 'AverageRetryCount', 
      Value: averageRetryCount,
      Unit: 'Count'
    }
  ]
});
```
# 🪞 結果・影響

### 期待される効果

1. **開発期間の短縮**: データベース設計、API実装、テスト工数を約1-2週間削減
2. **システム複雑性の軽減**: データモデルの理解しやすさと保守性の向上
3. **パフォーマンスの向上**: 送信処理時のDB書き込みオーバーヘッドの削減
4. **運用コストの削減**: ストレージ使用量とデータベース負荷の軽減

### 対応すべき制約・懸念

1. **詳細分析の制限**
	1. **懸念**: エラーパターンや送信パフォーマンスの詳細分析が困難
	2. **対策**: CloudWatch Insights によるログ分析、必要に応じてデータ可視化ツールの導入
2. **トラブルシューティングの複雑化**
	1. **懸念**: 送信失敗の根本原因調査がログベースで煩雑
	2. **対策**: 構造化ログの採用、ログ検索クエリのテンプレート化
3. **監査要件への対応**
	1. **懸念**: 詳細な送信履歴が求められる場合の対応困難
	2. **対策**: ログの長期保存設定、必要に応じて監査用ログエクスポート機能の実装

# 🍜 今後の検討事項

以下の条件に該当した場合、このADRの見直しを行う：

1. **詳細分析要件の発生**: 送信パフォーマンスの詳細分析が業務上必要になった場合
2. **監査要件の厳格化**: 法的要件により詳細な送信履歴の保存が義務化された場合
3. **規模拡大による問題**: ログベースの監視では対応できない規模の送信量に達した場合
4. **運用上の問題発生**: ログだけでは特定できない送信問題が頻発した場合

### 技術的制約の明確化

- **ログ保存期間**: CloudWatch Logs で90日間（延長可能）
- **ログ検索性能**: 大量ログに対するクエリパフォーマンスの制限
- **リアルタイム性**: ログベース監視のリアルタイム性に一定の制約
