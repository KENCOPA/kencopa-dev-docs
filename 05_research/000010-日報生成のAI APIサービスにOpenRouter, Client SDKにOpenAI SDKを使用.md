---
type: note
moc: "[[🏷️ADR]]"
tags:
- '#ai/ref'
---
## 要約

工程管理アプリケーション内で大規模言語モデル（LLM）へのアクセスに関して、OpenRouterをAPI提供元として選択し、クライアントライブラリには公式OpenAI SDKを採用することを決定しました。

## 背景

工程管理アプリケーション内で、日報生成機能などにGPT-4 Turboなどの高性能な大規模言語モデルを利用する必要があります。当初は以下の選択肢を検討していました：

- OpenAI API（直接）
- Microsoft Azure OpenAI Service
- ラッパーライブラリとして第三者のライブラリ（LangfuseなどのLLMオーケストレーションツール）

工程管理データに含まれる可能性のある企業固有の情報を扱うため、セキュリティ、コンプライアンス、運用面での要件を考慮し、最適な選択肢を検討しました。

## 決定事項

1. **API提供元**: OpenRouterを採用
2. **クライアントSDK**: 公式OpenAI SDKを採用

## 決定理由

### OpenRouterの採用理由

1. **複数サービスへの統一アクセス**:
    - OpenRouterは、OpenAI、Azure OpenAI、Anthropic（Claude）、Mistralなど複数のLLMプロバイダーへの統一的なアクセスを提供
    - 単一のAPIキーで多様なモデルにアクセス可能
2. **モデル切り替えの柔軟性**:
    - モデルやプロバイダーの変更が必要になった場合でも、コードの変更を最小限に抑えられる
    - APIインターフェースの統一により、異なるモデル間の実験や性能比較が容易
3. **コスト最適化の可能性**:
    - 用途に応じて最適なコスト/パフォーマンスを持つプロバイダーを選択可能
    - 特定のプロバイダーに依存せず、市場変化に応じたプロバイダー選択の自由度を確保
4. **フォールバック対応**:
    - 一つのプロバイダーで障害が発生した場合でも、自動的に別のプロバイダーにフォールバックできる可能性がある
5. **OpenAI互換API**:
    - OpenAI SDKとの互換性があり、標準的なAPIインターフェースを維持

### 公式OpenAI SDKの採用理由

1. **シンプルさ**:
    - 最もシンプルな実装が可能で、学習コストが低い
    - 不要な抽象化層を回避でき、デバッグが容易
2. **広範なコミュニティサポート**:
    - 最も広く採用されているSDKであり、情報やサポートが豊富
    - 最新の機能に迅速に対応している
3. **現状の要件に適合**:
    - 現時点での要件がシンプルであり、高度なオーケストレーションや複雑な制御フローが不要
4. **メンテナンス保証**:
    - OpenAIによる公式サポートがあり、APIの変更に対する迅速な対応が期待できる
5. **OpenRouterとの互換性**:
    - OpenRouterはOpenAI SDKと互換性があるため、同じSDKで両方のサービスにアクセス可能

## 代替案と検討結果

### 代替案1: Azure OpenAI Serviceの直接利用

**長所**:

- エンタープライズグレードのセキュリティとコンプライアンス
- Azureエコシステムとの統合が容易
- SLA（サービスレベル契約）の保証

**短所**:

- 単一プロバイダーへの依存
- モデルの切り替えが制限される
- 複数のAPIキー管理が必要（他のプロバイダーも使用する場合）

**決定**: OpenRouterが複数プロバイダー（Azure OpenAIを含む）へのアクセスを提供し、単一のAPIキーで管理できる利点が上回ると判断。

### 代替案2: Langfuseなどの高度なオーケストレーションツールの採用

**長所**:

- 高度なモニタリングと分析機能
- LLMの使用状況の可視化
- プロンプトとレスポンスの追跡機能

**短所**:

- 追加の抽象化層と複雑性
- 学習コストの増加
- 現状の要件に対して過剰な機能セット

**決定**: 現時点での要件がシンプルであり、過度な複雑さを避けるために見送り。将来的な要件変更に応じて再検討する余地あり。

## 影響

- システムアーキテクチャ: LLMとの通信部分が単一のインターフェースに統一される
- コード実装: OpenAI SDKの標準的な使用方法に従うシンプルな実装が可能に
- 運用: 単一のAPIキー管理で複数のLLMプロバイダーにアクセス可能に
- 将来的な拡張: 新しいモデルやプロバイダーの追加が容易に

## 実装ガイダンス

javascript

```javascript
// OpenRouterのAPIキーを使用したOpenAI SDKの設定例
import OpenAI from 'openai';

const openai = new OpenAI({
  apiKey: process.env.OPENROUTER_API_KEY,
  baseURL: 'https://openrouter.ai/api/v1',
  defaultHeaders: {
    'HTTP-Referer': 'https://example.com', // OpenRouter用の追加ヘッダー
    'X-Title': 'My Application'            // OpenRouter用の追加ヘッダー
  }
});

// 使用例
async function generateText(prompt) {
  const response = await openai.chat.completions.create({
    model: 'openai/gpt-4-turbo', // OpenRouter形式のモデル指定
    messages: [
      { role: 'system', content: 'あなたは役立つアシスタントです。' },
      { role: 'user', content: prompt }
    ]
  });
  
  return response.choices[0].message.content;
}
```

## 将来的な検討事項

1. **工程管理アプリケーション特有の要件への対応**:
    - 日報生成機能の拡張に伴うAI機能の強化
    - 工程表や進捗率チャートの分析・予測機能の追加
2. **ログ取得と分析機能の強化**:
    - 将来的にLangfuseなどの分析ツールの導入を検討
    - プロンプトとレスポンスの追跡・分析ニーズの増加に備える
3. **セキュリティ対策の強化**:
    - 工程管理データに含まれる企業情報や個人情報（PII）のマスキング機能の実装
    - 現場固有の機密情報保護対策の検討
4. **複数モデルの並列利用**:
    - 工程管理の各機能（日報生成、予測分析など）に最適化されたモデルの選択ロジックの実装
    - コスト効率とパフォーマンスのバランスを最適化するルーティング戦略

## 注釈

- この決定は現在の要件と市場状況に基づいており、技術の進化や要件の変化に応じて見直す必要がある
- OpenRouterの安定性と信頼性については継続的に評価し、必要に応じて代替手段を準備しておく
- **セキュリティ対策については現状は優先度を下げる**：
    - 現在はベータ版リリース前の段階であるため、機能実装に集中する
    - セキュリティ対策（LLM Guardなどを使用したマスキング、PII情報のリダクションなど）は今後改めて検討する
    - まずは基本機能を実装し、ユーザーフィードバックを得た上でセキュリティ要件を明確化する

