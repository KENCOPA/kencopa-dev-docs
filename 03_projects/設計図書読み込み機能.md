---
type: note
tags:
- '#ai/ref'
---
# システム要件

## あなたの役割
工事現場の設計図書からプロジェクト情報を抽出するバックエンドAPIシステムを実装してください。以下の仕様に従って、S3からファイルを取得し、LLMで情報抽出を行い、DynamoDBに保存する機能を構築します。

## API仕様
**エンドポイント:** `POST api/ai/v1/protected/design-document/load`

**リクエストパラメータ:**
```typescript
{
  tenantId: string;      // テナントID（必須）
  siteId: string;        // 工事現場ID（必須）
  requestId: string;     // リクエスト毎の一意なID（必須）
}
```

## データソース・保存先設定
- **S3バケット名:** `local-kunai-ai-design-documents`
- **S3オブジェクトキー:** `{tenantId}/{siteId}/`配下の全ファイル
- **DynamoDBテーブル名:** `local-kunai-ai-schedule-gen-config`
- **DynamoDBキー:** `id = requestId`

## 抽出対象データ構造
以下の情報を設計図書から抽出してください。値が見つからない場合は空文字列を設定します：

```typescript
interface ExtractedData {
  工事現場名: string;      // プロジェクト名称
  工事現場詳細: string;    // プロジェクトの詳細説明
  工事開始日: string;      // 開始予定日（YYYY-MM-DD形式）
  工事終了日: string;      // 完了予定日（YYYY-MM-DD形式）
}
```

**重要:** この抽出フォーマットは頻繁に変更される可能性があるため、設定ファイルまたは別モジュールで管理し、メインロジックから分離してください。

## WebSocketリアルタイム通信
処理進捗を以下の形式でWebSocketクライアントに送信してください：

```typescript
interface ProgressMessage {
  message: string;    // 処理状況メッセージ
  progress: number;   // 進捗率（0-100）
}
```

## 実装すべき処理フロー

以下の手順でシステムを実装してください。**手順6-8はLangGraphを使用した並列処理として実装します。**

### 1. リクエスト受信・検証
- リクエストパラメータのバリデーション
- 認証・認可チェック

### 2. ファイル取得開始通知
```json
{
  "message": "設計図書を取得中...",
  "progress": 20
}
```

### 3. S3からファイル取得
- `{tenantId}/{siteId}/`配下の全ファイルを取得
- ファイル形式の検証（PDF、画像等）

### 4. 情報抽出開始通知
```json
{
  "message": "設計図書から値を取得中...",
  "progress": 40
}
```

### 5. 並列情報抽出（LangGraph実装）
- 各ファイルから並列でデータ抽出
- LLMを使用した構造化データ抽出
- エラーハンドリング機能

### 6. データ統合開始通知
```json
{
  "message": "取得した値を整理中...",
  "progress": 60
}
```

### 7. データ統合処理
- 並列処理結果のマージ
- **重複データの統合:** 同一キーに異なる値がある場合、LLMを使用して意味的整合性を保持しながら統合
- データの正規化・検証

### 8. 保存開始通知
```json
{
  "message": "値を保存中...",
  "progress": 80
}
```

### 9. DynamoDB保存
- 抽出・統合データをDynamoDBに保存
- 保存エラー時のリトライ機構

### 10. 完了通知
```json
{
  "message": "読取完了",
  "progress": 100
}
```

## 技術要件
- **並列処理:** LangGraphによる効率的な並列データ抽出
- **ログ出力:** 各処理段階で詳細ログを出力
- **エラーハンドリング:** 部分的失敗への対応
- **設定管理:** 抽出フォーマットの外部化
- **パフォーマンス:** 大量ファイル処理への最適化
- **既存インフラ活用:** S3およびDynamoDBとの通信には既存のクライアント（`src/infrastructures/shared/clients`）を使用すること

## 実装時の注意点
1. WebSocket接続の安定性を考慮した実装
2. S3からの大容量ファイル取得時のメモリ管理
3. LLM APIの呼び出し制限への対応
4. DynamoDB書き込み時の整合性担保
5. 設定変更時の影響範囲最小化