---
type: note
---
> [!info] 必要なセクションを選択して使用してください！

# 📌 目的・対象範囲

- **目的**
  - 非エンジニアも RAG データを追加できるようにする
- **対象範囲**
  - 安全 AI の AI エージェントが参照するデータを増やしたい人

# 🚩 前提条件

- [azuchi-ai-agent](https://github.com/KENCOPA/azuchi-ai-agent)へアクセスできる
- [google drive](https://drive.google.com/drive/folders/1ovEhUFvDy_qJLJdxCrikxn_9J1sMcDV3)へアクセスできる

PR & を処理する人は下記も確認

- AWS（Dev/Stg/Prod）へアクセスできる
- pinecone へアクセスできる

## 仕様

### 📁 Google Drive のフォルダ構造について

AI エージェントが参照するドキュメントは、Google Drive で以下のような年月ごとのフォルダ構造で管理されています：

```
📁 RAGドキュメント管理フォルダ
├── 📁 2024/
│   └── 📁 0103/     ← 2024年1月3日の意味
└── 📁 2025/
    ├── 📁 0104/     ← 2025年1月4日の意味
    └── 📁 0105/     ← 2025年1月5日の意味
        └── 📄 土木工事共通仕様書.pdf
```

**ポイント**：

- 年（yyyy）とその下に月日（mmdd）の 2 階層で整理
- 日付フォルダの中に実際の PDF などのファイルを配置

### 📝 manifest.json について

各フォルダには `manifest.json` という設定ファイルがあり、どのファイルを AI エージェントに読み込ませるかを管理しています：

```json
{
  "target": "20250105",  ← この日付のフォルダを読み込み対象にする
  "metadata": [          ← ファイルの詳細情報リスト
    {
      "file": "土木工事共通仕様書.pdf",     ← ファイル名（完全一致が必要）
      "url": "https://example.com/source"   ← 元のファイルがある場所
    }
  ]
}
```

### 🔄 AI エージェントへの読み込み仕組み

1. **読み込み対象の決定**

   - `manifest.json` の `target` で指定された日付フォルダ（例：20250105 → 2025/0105/）のファイルが読み込まれます

2. **ファイル情報の紐付け**

   - `metadata` セクションのファイル名と実際のファイル名が **完全一致** していると、ファイルに詳細情報が自動で付与されます
   - この情報がないと AI エージェントがファイルを適切に参照できません

3. **バージョン管理**
   - ファイルのバージョンは配置した日付フォルダ名が自動で使われます
   - 例：`2025/0105/` に配置した場合、バージョンは `20250105` になります

### ⚙️ システム側の設定

- 現在 AI エージェントが参照しているバージョンは[こちらのコード](https://github.com/KENCOPA/azuchi-ai-agent/blob/8aede7a65bcf514d281d55baf1892f76e835c5f5/templates/function.cfn.yml#L411)で確認できます
- 新しいファイルを追加した場合、この設定も更新が必要です

# 📋 実施手順

## 📂 パターン 1：既存のバージョンに新しいファイルを追加する場合

**用途**：既存の仕様書に加えて、新しい資料を AI エージェントに覚えさせたい場合

> [!tip] 例：現在の仕様書は残して、新しい技術資料を追加したい

### 1️⃣ Google Drive の既存フォルダにファイルを追加

1. [Google Drive](https://drive.google.com/drive/folders/1ovEhUFvDy_qJLJdxCrikxn_9J1sMcDV3)にアクセス
2. 現在使用中のフォルダ（例：`2025/0105/`）を開く
3. 追加したい PDF ファイルをアップロード

### 2️⃣ manifest.json を更新

1. 同じフォルダ内の `manifest.json` を開く
2. `metadata` セクションに新しいファイル情報を追加：
   ```json
   {
     "file": "新しいファイル名.pdf",
     "url": "https://元のファイルのURL"
   }
   ```
3. **重要**：ファイル名は完全一致させる

### 3️⃣ エンジニアに連絡

以下を伝えて処理を依頼：

- 追加したファイル名
- 追加した日付
- 「既存バージョンへの追加」である旨

---

## 🔄 パターン 2：新規バージョンを発行する場合

**用途**：

- 年度変更などで既存の仕様書を全体的に入れ替える場合
- 過去のバージョンとの差分を残したい場合（AI エージェントが複数バージョンを参照できるようにする）

> [!tip] 例：令和 6 年版から令和 7 年版への更新、令和 6 年と令和 7 年の両方を参照できるようにしたい場合

> [!note] **複数バージョン参照の効果**
>
> 複数バージョンを同時に参照させることで、AI エージェントが以下のような比較回答ができるようになります：
>
> - **ユーザー**：「コンクリートの養生期間について教えて」
> - **AI エージェント**：「令和 6 年版では ○○ 日でしたが、令和 7 年版では △△ 日に変更されました。主な変更理由は〜」
>
> このように、バージョン間の差分を踏まえた回答が可能になります。

### 1️⃣ 最新フォルダをコピーして新規ディレクトリを作成

1. 現在使用中のフォルダ（例：`2025/0105/`）を **フォルダごと** コピー
2. 新しい日付フォルダを作成（例：`2025/0201/`）
3. コピーしたファイルをすべて新しいフォルダに配置

> [!warning] **重要**：差分更新は禁止！必ず過去のファイルも含めて全てコピーする

### 2️⃣ 更新したいファイルを入れ替える

1. 新しいフォルダ内で、更新が必要なファイルを新しいバージョンに置き換え
2. 不要になったファイルがあれば削除

### 3️⃣ manifest.json を更新

1. `target` を新しい日付に変更：
   ```json
   {
     "target": "20250201",  ← 新しい日付
     "metadata": [...]
   }
   ```
2. ファイル一覧を確認し、追加・削除・変更があれば `metadata` も更新

### 4️⃣ アプリケーションコードの設定値を変更

1. [こちらのファイル](https://github.com/KENCOPA/azuchi-ai-agent/blob/8aede7a65bcf514d281d55baf1892f76e835c5f5/templates/function.cfn.yml#L411)を編集
2. 以下の行を新しい日付に変更：
   ```yaml
   BEDROCK_LATEST_DOCUMENT_VERSION: !If [IsProd, "20250201", "20250201"]
   ```
3. GitHub で Pull Request（PR）を作成

### 5️⃣ エンジニアに連絡

以下を伝えて処理を依頼：

- 新しいバージョン番号
- 変更内容の概要
- 作成した PR の URL

---

## 👨‍💻 エンジニアの対応フロー

### 1️⃣ ドキュメントの追加処理

各環境（Dev/Stg/Prod）で以下を実行：

- lambda の`[Env]-azuchi-ai-agent-preprocess-api-main` を実行
- Knowledge Base にドキュメントをインポート

### 2️⃣ 追加確認

以下の場所でドキュメントが正しく追加されているか確認：

- AWS Knowledge Base
- Pinecone

### 3️⃣ 新規バージョンの場合のみ：PR マージ

- 作成された Pull Request を確認
- 問題なければマージして本番環境に反映

### 4️⃣ 動作確認

各環境の UI から以下を確認：

- 新しいドキュメントに関する質問を AI エージェントに投げる
- 適切な回答が返ってくるか確認

# 🚧 注意事項

- あくまで version で指定されたドキュメントしか参照しないため、新規ディレクトリを作る際は過去のドキュメントもコピペする。差分更新してはならない。
