---
type: note
moc: "[[🏷️基本設計書]]"
tags:
- ai/ref
- ai
---
# 概要
## 目的

本機能は、建設工事における日々の作業実績を工程管理システムから自動的に日報として生成し、関係者へ効率的に共有することを目的としています。従来は工程表と日報が別々に管理されていたため、同様の情報を二重入力する必要がありました。本機能により、既に入力された工程管理データから日報を自動生成することで、データ入力の重複を排除し、業務効率の向上を図ります。

## 主要機能の概要

1. **日報自動生成機能**
    - 工程管理データ（予定・実績）から日報を自動生成
    - 実績データが未入力の場合の入力促進機能
	- ==**AI支援による自然言語の日報文章生成**==
		- OpenAI APIを活用し、工程データから読みやすく自然な日報文章を自動作成
2. **メール送信機能**
    - 宛先の指定（メーリングリスト選択・個別アドレス追加）
    - 送信元アドレスの指定
    - 件名・本文のカスタマイズ
    - メール内容の一時保存
3. **添付ファイル機能**
    - 画像・ファイルの添付
    - 工程表の画像自動生成・添付
    - ドリリングチャートの画像自動生成・添付
    - 出来高進捗率チャートの画像自動生成・添付
4. **データ連携機能**
    - 工程管理システムとの双方向データ連携
    - 日報で入力した実績データの工程表への反映

これらの機能により、工程管理と日報作成の一元化を実現し、二重管理の解消と業務効率化を達成します。さらに、AI技術の活用により、データから意味のある文脈を抽出し、建設業界の専門用語や表現を適切に用いた高品質な日報を効率的に生成します。人間による最終確認と編集の工程を残しつつも、下書き作成の負担を大幅に軽減します。

# 要件定義

## ユーザーストーリー

### メーリングリスト作成・管理

1. **現場責任者として**、工事案件ごとにメーリングリストを作成したい。それにより、日報送信の作業効率を向上できる。
2. **工事管理者として**、よく使うメーリングリストをお気に入りに登録したい。それにより、頻繁に使用するリストに素早くアクセスできる。
3. **プロジェクトマネージャーとして**、複数の現場担当者が使えるメーリングリストを共有したい。それにより、チーム全体での連絡先管理を統一できる。
4. **事務担当者として**、不要になったメーリングリストを整理したい。それにより、リスト一覧を整理して使いやすく保てる。

### メンバー管理

1. **現場責任者として**、システム登録ユーザーをメーリングリストに追加したい。それにより、社内メンバーを簡単にリストに含められる。
2. **現場責任者として**、外部協力会社など未登録のメールアドレスをメーリングリストに追加したい。それにより、システム外の関係者にも日報を送信できる。
3. **システム管理者として**、無効になったメールアドレスを検出して通知したい。それにより、送信失敗を事前に防止できる。

### 日報送信との連携

1. **現場責任者として**、日報作成時にメーリングリストを選択したい。それにより、送信先の個別入力の手間を省ける。
2. **工事担当者として**、日報のデフォルトメーリングリストを設定したい。それにより、毎回同じ宛先を選択する手間を省ける。
3. **現場責任者として**、メーリングリストと個別アドレスを組み合わせて送信したい。それにより、特定の場合に追加の宛先を含められる。
## 機能要件

### メーリングリスト基本機能

1. システムは、ユーザーが新規メーリングリストを作成できること
2. システムは、メーリングリストに名前と説明を設定できること
3. ~~システムは、メーリングリストを特定のプロジェクト/工事に関連付けられること~~
	- 現状メーリングリスト画面からの紐付けは実装しない
	- 将来的にあると良いかも
4. システムは、メーリングリストの一覧を表示し、検索・フィルタリングできること
5. システムは、メーリングリストを編集・削除できること
6. システムは、メーリングリストを複製できること
7. システムは、会社登録済みユーザーをメーリングリストに追加できること
8. システムは、未登録の外部メールアドレスをメーリングリストに追加できること
9. システムは、追加される外部メールアドレスの基本的な形式検証を行えること
10. システムは、メーリングリストから複数のメンバーを一括選択・削除できること
11. システムは、メンバーの所属（社内/社外）を区別して表示できること
12. システムは、メーリングリストのメンバー数や構成を表示できること
13. システムは、外部メールアドレスが会社登録済みユーザーとして登録された場合、メーリングリスト内では会社登録済みユーザーとして扱えること
### メール送信機能

1. システムは、メーリングリストから送信先を選択できること
2. システムは、メーリングリスト以外のメールアドレスを手動で追加できること
	1. 現場に参加しているメンバーのアドレスはあらかじめリスト・強調表示できること
3. システムは、工事現場ごとにデフォルトの送信先を設定できること
4. システムは、送信元アドレス（返信先）を指定できること
5. システムは、編集済みの日報をメールとして送信できること
6. システムは、作成途中の日報を一時保存できること
7. システムは、過去に保存した日報を読み込み、編集・送信できること
### 添付ファイル機能

1. システムは、ユーザーが選択した画像やファイルを日報メールに添付できること
2. システムは、選択した期間の工程表を画像として自動生成し、添付できること
	1. 期間は以下
		1. 全体・週・月・六ヶ月
3. システムは、選択した工程のドリリングチャートを画像として自動生成し、添付できること
4. システムは、出来高進捗率チャートを画像として自動生成し、添付できること
5. システムは、ユーザーがアップロードした画像を削除できること
### 実績データ管理機能

1. システムは、日報生成のために必要な実績データを入力するフォームを提供できること
2. システムは、入力された実績データをリアルタイムで工程管理システムに反映できること
3. システムは、工程ごとの作業内容、作業量、使用した人員・機材・材料などの情報を記録できること
4. システムは、予定外の作業実績も入力・記録できること

### データ保存・管理機能

1. システムは、送信済み日報の履歴を保存し、閲覧できること
2. システムは、一時保存した日報を90日間保持し、期限を過ぎたものは自動的に削除できること
3. システムは、添付ファイルを一定期間保存し、管理できること

# 非機能要件

## 画像保持期間

ユーザーが添付した画像ファイルは、システム側で永続的に保持する必要はありません。メール送信後、画像ファイルはシステム上で一時的に保存されますが、不要なストレージ消費やプライバシー保護の観点から、一定期間経過後に自動的に削除されます。

保持期間は「90日間」とし、90日を経過した画像ファイルはシステムによって自動的に削除されます。

## 外部サービス連携セキュリティ 

### AI API Key

- APIキーはTerraform(sensitive=true)で管理
- AWS Parameter StoreにSecure Stringとして保存
- APIキーの環境変数利用禁止
### データプライバシー保護

- OpenAIへの送信データの匿名化
    - 個人情報（氏名、連絡先等）の除去
    - 企業機密情報のマスキング
- データ使用目的の明確化と文書化
- OpenAIデータ使用ポリシーの定期レビュー

> [!info]
> 個人情報のマスキングはDBのプロパティ名から可能
> => LLM GUARDがLLM時に色々やってくれる=>pythonのみ
> => Langchainにはある
> それ以外はどうするのか？
> また、データ使用ポリシーなど、この辺り明確になっているのだろうか？
> ==[結論]本設計ドキュメント・実装では考慮しない==
### コンプライアンス考慮事項

- 建設業界の規制要件への対応
- 生成コンテンツの責任所在の明確化
- 人間によるAI生成コンテンツの最終確認プロセス

> [!info]
> ==本設計ドキュメント・実装では考慮しない==

## 脆弱性対策

### AI特有の脆弱性対策

- プロンプトインジェクション対策
    - ユーザー入力のサニタイズ
    - システムプロンプトとユーザープロンプトの分離
- モデル出力の検証と無害化
- 悪意のあるコンテンツ生成の防止対策

> [!info]
> ==本設計ドキュメント・実装では考慮しない==
O

## メール送信関連
メール送信には、AWS SESV2を使用する。

refs:
```cardlink
url: https://docs.aws.amazon.com/ja_jp/ses/latest/dg/quotas.html
title: "Amazon SES の Service Quotas - Amazon Simple Email Service"
description: "Amazon SES のリソースとオペレーションに適用されるクォータの一覧を示して説明します。"
host: docs.aws.amazon.com
favicon: https://docs.aws.amazon.com/assets/images/favicon.ico
```

### メッセージのクォータ

ses v2を使用する。メールサイズは40MBを超えないようにする必要がある。

| リソース                                                                                                                                                                                | デフォルトのクォータ                        | 調整可能                                                                                                                      |
| ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------- | ------------------------------------------------------------------------------------------------------------------------- |
| [SES v1 API](https://docs.aws.amazon.com/ses/latest/APIReference/) の使用 - 最大メッセージサイズ (添付ファイルを含む)                                                                                     | メッセージあたり 10 MB（base64 エンコーディング後）  | なし_(メッセージサイズが 10 MB を超えるワークロードの場合は、[SES v2 API](https://docs.aws.amazon.com/ses/latest/APIReference-V2/) への移行を考慮してください)。_ |
| [SES v2 API](https://docs.aws.amazon.com/ses/latest/APIReference-V2/) または [SMTP](https://docs.aws.amazon.com/ja_jp/ses/latest/dg/send-email-smtp.html) の使用 - 最大メッセージサイズ (添付ファイルを含む) | メッセージあたり 40 MB (base64 エンコーディング後) | いいえ                                                                                                                       |
|                                                                                                                                                                                     |                                   |                                                                                                                           |
> 10 MB を超えるメッセージは帯域幅スロットリングの対象となり、送信レートによっては最低 40 MB/s に調整される場合があります。例えば、40 MB のメッセージを 1 秒あたり 1 メッセージ、または 20 MB のメッセージを 1 秒間に 2 つ送信できます。

### 受信者のクオータ

1メッセージあたりのRecipientは最大50人までである。

|                  |                                                                               |                 |
| ---------------- | ----------------------------------------------------------------------------- | --------------- |
| メッセージあたりの受取人の最大数 | メッセージあたり 50 人の受取人。<br><br>###### 注記<br><br>受取人は「To」、「CC」、または「BCC」アドレスのいずれかです。 | 受信者の制限は調整できません。 |


# 画面レイアウト

## コンセプト

ITに慣れていないユーザーが日々の作業として日報を送る場合、最も効果的なのは「今日何をすべきか」が一目でわかるタイムライン型UIです。画面上部に今日の日報作成を促す大きなセクションを配置し、過去の日報は時系列で表示することで、直感的な操作が可能になります。

また、AI生成機能を活用して日報テキストの下書きを自動作成し、ユーザーは確認と必要な修正だけを行うフローにすることで、入力の手間を大幅に削減できます。このアプローチにより、ITに不慣れなユーザーでも最小限の操作で日報業務を完了できる
## 内容

[[🗒️ 日報自動生成_architecture]]　画面レイアウトを参照
## 設計ポイント

1. **最優先表示：今日の日報**
    - 画面上部に「今日の日報」セクションを大きく表示
    - 未作成の場合は目立つ「作成する」ボタンを表示
    - すでに下書きがある場合は「編集する」ボタンに変更
2. **時系列リスト表示**
    - 日付ごとに視覚的に区切られたカード形式
    - 各日の送信状態（未送信/送信済み/下書き）を色とアイコンで明示
    - 送信済み日報には基本情報と「詳細」「複製」ボタンを表示
3. **シンプルなフィルター**
    - 「今週/先週/2週間前/すべて」のようなわかりやすいフィルター
    - 複雑な検索機能は二次的に配置
4. **アクション指向のUI**
    - 主要アクションを大きめのボタンで表示
    - 「作成」「編集」「複製」など直感的なラベル


### 代替案と比較

#### 日報Home画面
-  **Gmail風インボックス型UI**
	- メリット: メールクライアントの感覚で使える
	- デメリット: 日報という日次タスクの性質と合わない可能性
- **カレンダー型UI**
    - メリット: 日付との関連が視覚的に分かりやすい
    - デメリット: 一覧性に欠け、過去の日報検索が煩雑になる可能性
    

# 機能詳細

refs:
- [[🗒️ 日報自動生成_architecture]] 
## 処理フロー

### 件名・本文自動生成
![[スクリーンショット 2025-05-12 20.33.28.png]]

==ポイント==：
- 送信元と送信先を入力した後にAIで生成するボタンが押下可能
	- メール本文に送信元情報を入れるため
- 外部AIサービスには以下のデータを使用する
	- 本日の予定・実績データ（子アイテムも含む)
	- 工程自体のデータ
	- 現場情報
		- 現場名
	- 本日のお天気
		- weather apiから取得

### ファイルアップロード詳細

ユーザーが手動でファイルのアップロードを行う。
基本的に安全パトロール画像のアップロードと構成は同じである。
1. CognitoからS3に対する一時的なアクセス情報を取得
2. 画像を所定のS3バケットにPut
	1. 形式（S3 Object Key)
			2. `reports/{report-id}/{uuid}.{拡張子}`
3. Putした情報をDBに保存
	1. プロパティ
		1. `objectKey`: 2.で保存したS3 Object Key
		2. `originalFileName`: ユーザーがアップロードしたファイル名 
		3. `fileSize`: ファイルサイズ
			1. SESの容量上限チェック
			2. プロジェクトごとの容量監視が可能
			3. ユーザー向けファイル一覧でのサイズ表示
		4. `contentType`: コンテンツタイプ
			1. ファイル形式の検証・制限
				1. 許可されたファイル形式のチェック
			2. ファイル種別による処理の分岐
				1. 画像ファイルのプレビュー生成
					1. 画像ファイルの場合のみサムネイル生成など
				2. ウイルススキャンの対象判定:
					1. 実行可能ファイルや危険なファイル形式の検出
				3. ファイル種別に応じたアイコン表示:
					1. ブラウザ内プレビューの可否判定
				=> これらはpresignedUrlによる取得以前にUIレベルで判断が必要のため
				4. SESでのメール制限
					1. SES添付ファイル送信では content-type が重要
						1. **受信者のメールクライアントでの適切な表示**
						    - 正しい Content-Type がないと「不明なファイル形式」として表示される
						    - セキュリティ警告が表示される可能性
						2. **スパムフィルターの回避**
						    - 不正確な Content-Type はスパム判定の要因となる
						    - 実際のファイル内容と Content-Type の不一致は危険信号
						3. **メールクライアントでのプレビュー**
						    - OutlookやGmailでのプレビュー機能は Content-Type に依存

#### ファイル名を直接S3に保存しない
ADR: [[🗒️ 000011-日報添付ファイルのオブジェクトストレージへの保存はUUID.拡張子で行う]]

#### S3バケットプレフィックスに年月を入れない
ADR: [[🗒️ 000012-日報添付ファイルのオブジェクトストレージへの保存時に、バケットプレフィックスに年月を入れない]]

#### ファイルアップロードにreact-dropzoneライブラリを使用する
ADR:  [[🗒️ 000018-日報ファイルアップロードにreact-dropzoneライブラリを使用する]]

#### 入力値としてのサイズ上限は25MBとする
ADR: [[🗒️ 000020-日報のファイルサイズ上限は25MBとする]]

### 工程表・出来高などのチャート画像の自動生成

以下以外は基本的にファイルアップロードと同じである
1. **画像生成処理**
    - 前述と同様に、ガントチャートやその他のコンポーネントを画像キャプチャライブラリで取得する
	    - ADR: [[🗒️ 000021-ガントチャートの画像生成に、dom-to-imageライブラリを使用する]]
	- また、データが存在する全期間を出力対象とし、ユーザーに期間の選択やスクロールはさせない
### Email送信詳細

#### 前提条件

- 下書きから本番日報への変換が完了済み
- 宛先・送信者情報が本番テーブルに登録済み
- 添付ファイルがS3の本番領域に移動済み

#### メール送信処理手順

##### 1. 送信前の検証・準備
1. 日報データの存在確認とステータスチェック
2. 送信者情報の取得・検証
3. 宛先情報の取得（メーリングリスト展開）
4. 添付ファイル一覧の取得
5. 合計ファイルサイズの計算とSES制限（10MB）のチェック
6. 送信可能状態の確認（AWS SES認証状態など）
##### 2. 受信者詳細テーブルの準備
1. メーリングリストの展開処理
    - メーリングリストIDから実際のメンバー一覧を取得
    - 各メンバーを受信者詳細テーブルに登録
2. 個別指定アドレスの登録
    - 個別アドレステーブルから取得
    - 受信者詳細テーブルに登録
3. 重複メールアドレスの排除（UNIQUE制約による）
4. 受信者詳細の初期状態設定（sendStatus: 'pending'）

##### 3. 添付ファイルの準備
1. S3から添付ファイルの取得
2. ファイル存在確認
3. ファイル内容の読み込み（Buffer化）
4. Nodemailer用の添付ファイル配列作成
	1. filename: 元のファイル名
	2. content: ファイルのBuffer
	3. contentType: MIMEタイプ

##### 4. 送信対象の分割処理
1. 送信制限を考慮したバッチサイズの決定（例：10件/バッチ）
2. 受信者リストのバッチ分割
3. 各バッチの送信間隔の設定（レート制限対策）

##### 5. 実際のメール送信処理（各受信者に対して）
1. Nodemailer + SES トランスポーターの作成
	1. ref: [[🗒️ 日報#Emailで画像を送る]]
	2. ADR: [[🗒️ 000019-日報メール送信にAmazon SES (v2) + nodemailerを使用する]]
2. メールオプションの構築
	2. from: 
	3. to: 受信者アドレス
	4. subject: 件名
	5. html: 本文
	6. attachments: 添付ファイル配列
3. SESを使用したメール送信実行
4. 送信結果の取得（messageId or エラー）
##### 6. リトライ戦略の実装
1. ~~エラータイプの判定~~
    - ~~リトライ可能エラー：Throttling, NetworkError, TemporaryFailure~~
    - ~~リトライ不可エラー：InvalidEmail, MessageRejected, ConfigurationError~~
2. ~~リトライカウンターの確認（最大3回）~~
3. ~~指数バックオフによる待機時間計算（1秒 → 2秒 → 4秒）~~
4. ~~待機後の再送信実行~~
5. ~~最大リトライ回数到達時の最終失敗判定~~

現状リトライ実装は行わない。送信エラーになるが、DBレコードの状態は"DRAFT"のままであり、再送が可能であるためである。

##### 7. 送信結果の記録

1. ~~成功時の処理~~
    - ~~`WorkDailyReportRecipientDetail` の sendStatus を 'sent' に更新~~
	    - ~~==sesの"メール送信に成功”という状態なので、受信者が正しく受け取れたかは別である==~~
	    - ~~実際に受信者に届いたか、バウンスしたかは後で分かる~~
		- ~~バウンスやスパム報告は数分〜数時間後に発生することがある~~
		- ~~[[🗒️ 日報#メール送信のバウンス・スパム報告について]]を参照~~
    - ~~sentAt に送信時刻を記録~~
    - ~~attemptCount にリトライ回数を記録~~
2. ~~失敗時の処理~~
    - ~~sendStatus を 'failed' に更新~~
    - ~~errorMessage にエラー詳細を記録~~
	    - ~~最終的なエラーを記載する~~
    - ~~attemptCount に試行回数を記録~~

メールの送信結果はプログラム上で同リクエストスコープ内で取得できない。よって上記は非同期で行う必要がある。具体的には、[[🗒️ 000015-日報メール送信のバウンス・苦情処理は現時点では行わない]]内で記載しているSNSなどを用いて実装する必要がある。


##### 8. 全体送信ステータスの判定・更新

30. 全受信者の送信結果を集計
31. 日報全体のステータス判定
    - ~~全員~~成功 → 'sent'
    - ~~全員失敗 → 'failed'~~
    - ~~一部失敗 → 'partiallySent'~~
    - 失敗した場合は、インフラ層(SES, Email Clientなど)が例外をスローする
    - 一時的なエラーなどの可能性もあり、再送可能にするため、ステータスは変更しない
32. `WorkDailyReports` テーブルの status 更新
33. sendAt に送信完了時刻を記録
##### 9. 後処理・通知

34. 送信結果サマリーの作成
35. 送信失敗がある場合のエラーレポート作成
36. ユーザーへの送信完了通知（WebSocket経由など）
37. 管理者への異常通知（失敗率が高い場合）

#### エラーハンドリングのポイント
##### リトライ対象のエラー
- `Throttling` - AWS SES の レート制限
- `RequestTimeout` - リクエストタイムアウト
- `ServiceUnavailable` - AWS サービス一時停止
- `NetworkingError` - ネットワーク接続エラー

##### リトライ非対象のエラー

- `MessageRejected` - メール内容の問題
- `InvalidParameterValue` - パラメータエラー
- `AccountSendingPausedException` - アカウント停止
- `MailFromDomainNotVerifiedException` - ドメイン未検証

#### リトライ戦略
- 1回目失敗 → 1秒待機 → 2回目実行
- 2回目失敗 → 2秒待機 → 3回目実行  
- 3回目失敗 → 最終失敗確定

### 会社メーリングリスト削除について

ADR: [[🗒️ 000014-会社メーリングリストは論理削除にする]]

### メール送信のバウンス・スパム報告について

ADR: [[🗒️ 000015-日報メール送信のバウンス・苦情処理は現時点では行わない]]

### メール送信の非同期処理について

大量のメールを一度に送るわけではないので行わない。

### スロットリング対策について

送信時エラーが出るが、DBレコード値のstatusは"DRAFT"のままであるので再送可能である。
よって現状行わない。

## 外部サービス連携

### 外部AIサービス/Client SDK

外部AIサービスには、OpenRouter, OpenAI SDKを使用する。
ADR: [[🗒️ 000010-日報生成のAI APIサービスにOpenRouter, Client SDKにOpenAI SDKを使用]]
#### 基本情報
- **使用モデル**: GPT-4 Turbo
- **API連携方式**: AWS Lambdaからの直接呼び出し
- **リクエスト処理**:
    - 工程データを構造化されたJSONとして整形
    - システムプロンプトで日報形式を指定
    - ユーザープロンプトで当日の工程データを提供
- **レスポンス処理**:
    - 生成テキストのサニタイズと検証
    - ユーザーが編集可能な形式での返却

## データモデル

see [[🗒️ 日報自動生成_architecture]]

### 日報下書きテーブルを作成しない

ADR: [[🗒️ 000017-日報の下書きテーブルは作成しない]]

### WorkDailyReportDeliveryAttempt テーブルの実装見送り
ADR: [[🗒️ 000013-日報EmailのWorkDailyReportDeliveryAttempt テーブルの実装見送り]]



## Emailで画像を送る

```cardlink
url: https://www.nightswinger.dev/2021/11/using-aws-ses-with-nodemailer-in-nodejs/
title: "Node.js で AWS SES を使うなら Nodemailer がおすすめ"
description: "概要 Javascriptで AWS SES を使ってメールを送信したい場合はメールクライアントとして nodemailer がおすすめです。 AWS SESが提供するAPIでメール送信"
host: www.nightswinger.dev
favicon: https://www.nightswinger.dev/favicon.ico
```

> AWS SESが提供するAPIでメール送信に画像などを添付したいと思ったら MIMEフォーマットの文字列を自分で組み立てないといけませんが nodemailerを使えばそれらの煩雑な作業なしにメール送信ができます。  

