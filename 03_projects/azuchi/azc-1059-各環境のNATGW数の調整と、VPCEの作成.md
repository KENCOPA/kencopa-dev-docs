---
type: note
moc: "[[🏷️基本設計書]]"
tags:
- azc-1059
- '#ai/ref'
---
> [!info] 必要なセクションを選択して使用してください！


refs:
- 検討事項ドキュメント
	- 
```cardlink
url: https://www.notion.so/naka-time/AWS-EC2-other-1e8701ffa9c480cab8f5c6133dfc42a1
title: "Your connected workspace for wiki, docs & projects | Notion"
description: "A new tool that blends your everyday work apps into one. It's the all-in-one workspace for you and your team"
host: www.notion.so
image: https://www.notion.so/images/meta/default.png
```

# 背景

EC2(other)の使用料金が他と比べてかなり高い。organization accountの請求を見ると、すべてのアカウント合計で180ドルかかっている。
natgwに料金がかかっているようだ。

# 調査

## NATGWの使用と配置

現状core-apiのLambdaはvpc内ソースである。s3などのグローバルリソースへのアクセスに使用していると思われる。

natgwはすべてのazに配置されている。

## core-apiのグローバルリソースへのアクセス

- s3
    - 各種画像やテンプレート
- cloudwatch logs
    - ログ出力
- cognito
    - 認証認可
- ses
    - アカウント登録メールなど

## NATGWとVPCEndpointの比較

vpc(private)からグローバルリソースへのアクセスには、natgwか、vpc endpointの２通りがある。

### 基本料金

NAT Gatewayのコスト

- 時間料金: 約0.045ドル/時間/NAT Gateway (約33-38ドル/月/AZ)
- データ処理: 約0.045ドル/GB

VPC Endpointsのコスト

1. **Gateway Endpoints** (S3とDynamoDB用):
    - 時間料金: 無料
    - データ処理料金: 無料
2. **Interface Endpoints** (他のAWSサービス用):
    - 時間料金: 約0.01ドル/時間/AZ (約7-9ドル/月/AZ)
    - データ処理: 約0.01ドル/GB

## コスト見積もり (By Claude3)

### シナリオ1: NATゲートウェイ1台使用

|項目|計算式|月額コスト (USD)|
|---|---|---|
|NATゲートウェイ時間料金|0.045 USD × 730時間|32.85|
|データ処理料金 (50GB/月と仮定)|0.045 USD × 50GB|2.25|
|**合計**||**35.10**|

### シナリオ2: 1つのAZのみにVPCエンドポイントをデプロイする場合 (1AZ)

| 項目                                   | 計算式                     | 月額コスト (USD) |
| ------------------------------------ | ----------------------- | ----------- |
| S3ゲートウェイエンドポイント                      | 無料                      | 0.00        |
| CloudWatch Logsインターフェースエンドポイント (1AZ) | 0.014 USD × 730時間 × 1AZ | 10.22       |
| Cognitoインターフェースエンドポイント (1AZ)         | 0.014 USD × 730時間 × 1AZ | 10.22       |
| SESインターフェースエンドポイント (1AZ)             | 0.014 USD × 730時間 × 1AZ | 10.22       |
| データ処理料金 (50GB/月と仮定)                  | 0.01 USD × 50GB         | 0.50        |
| **合計**                               |                         | **31.16**   |

### データ転送量による損益分岐点の分析

NATゲートウェイとVPCエンドポイント（シナリオ2: 1AZ）のコストが等しくなるデータ転送量を計算します。

NATゲートウェイコスト = VPCエンドポイントコスト 32.85 + (0.045 × x) = 30.66 + (0.01 × x) 0.035x = 2.19 x = 62.57 GB/月

つまり、月間データ転送量が約63GB以上になると、1AZのVPCエンドポイント構成の方がコスト効率が良くなります。

### 考慮すべき追加要素

1. **可用性**: 1AZのみのVPCエンドポイント構成は、そのAZに障害が発生した場合、サービスの可用性に影響を与える可能性があります。
2. **スケーラビリティ**: NATゲートウェイはスループットを自動的にスケールしますが、大量のトラフィックが発生する場合はVPCエンドポイントの方がパフォーマンス面で有利な場合があります。
3. **セキュリティ**: VPCエンドポイントを使用すると、トラフィックがAWSネットワーク内に留まるため、セキュリティの観点からは優れています。

### 推奨設定

1. **S3へのアクセス**: いずれの場合もS3ゲートウェイエンドポイント（無料）を使用することを強く推奨します。
2. **データ転送量が少ない場合（月間63GB未満）**: NATゲートウェイ1台を使用する構成が最もコスト効率が良いです。
3. **データ転送量が多い場合（月間63GB以上）**: 単一AZ構成のVPCエンドポイントがコスト面で有利になります。ただし、可用性を考慮して重要なワークロードの場合は複数AZへの展開を検討してください。
4. **ハイブリッド構成**: S3ゲートウェイエンドポイント（無料）を設定し、その他のサービスへのアクセスにはNATゲートウェイを使用する構成も検討可能です。

### 結論

データ転送量が少ない場合（月間63GB未満）は、NATゲートウェイを1台使用する構成が最もコスト効率が良いです。ただし、S3へのアクセスには必ず無料のS3ゲートウェイエンドポイントを設定することで、さらにコストを削減できます。

データ転送量が多い場合や、より高いセキュリティ要件がある場合は、VPCエンドポイント構成（特に単一AZ）の方が有利になる可能性があります。

各環境の要件や予想されるトラフィックパターンに基づいて、最適な構成を選択することをお勧めします。

- vpc endpointとnatgwはどちらの通信経路が優先されるのか
    
    S3ゲートウェイVPCエンドポイントとNATゲートウェイの両方が設定されている場合、S3へのアクセスは自動的にVPCエンドポイント経由でルーティングされます。これはVPCのルートテーブルの優先順位によるものです。
    
    具体的には、以下のメカニズムで動作します：
    
    1. VPCルートテーブルでは、より具体的なルートが優先されます
    2. S3ゲートウェイエンドポイントを設定すると、そのサブネットのルートテーブルに「pl-xxxxxxxx (S3のprefix list)」へのルートが追加されます
    3. このルートはS3の特定のIPアドレス範囲に限定されるため、一般的なインターネット向け（0.0.0.0/0）のNATゲートウェイルートよりも優先されます
    
    つまり、S3へのトラフィックは自動的に無料のS3ゲートウェイエンドポイント経由で転送され、NAT Gateway経由のデータ処理コストを回避できます これにより、VPC Lambda→S3への通信が、VPC Lambda→Gateway VPC Endpoint for S3→S3 となりました。 [BTC Cloud](https://cloud.bigtreetc.com/column/gateway-endpoint/)
    
    このメカニズムはコスト削減に非常に効果的です。NAT Gateway経由のトラフィックは0.045 USD/GBの処理料金がかかりますが、S3ゲートウェイエンドポイント経由のトラフィックは完全に無料です 注意しなければならないのは、プライベートサブネットにあるEC2からS3やDynamoDBなどAWSリソースへの通信もNAT Gatewayを経由した場合はデータ処理料金が発生します
    

# 検討結果

- prodのみ3azでnatgwを使用する
    - 今はすべてのアカウントで3azにnatgwを配置している
    - 本番のみ、可用性を考慮し3az（もしくは2az)に配置する
    - dev, stgは1azで良い
    - パフォーマンスや、料金の問題が発生したときに再検討する
- s3 vpce(gateway endpoint)を作成する
    - 無料であり、かつnatgwより通信ルートが優先される


