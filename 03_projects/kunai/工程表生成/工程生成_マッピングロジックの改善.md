---
type: note
moc: "[[ğŸ·ï¸åŸºæœ¬è¨­è¨ˆæ›¸]]"
tags:
- '#ai/ref'
---
# ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ã®æ”¹å–„

## ã‚„ã‚ŠãŸã„ã“ã¨

- activityã«å¯¾ã—ã¦ã€workTypeã¨workUnitã‚’ãƒãƒƒãƒ”ãƒ³ã‚°ã—ãŸã„

## èª²é¡Œ

- workType/Unitã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»»æ„ã«å¢—ã‚„ã™ã“ã¨ãŒã§ãã‚‹ã®ã§ã€‚ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®å•é¡Œã«ç›´é¢ã™ã‚‹
- activityæ•° < workType/Unitæ•°ãªã®ã§ã€activityã§ãƒãƒ£ãƒ³ã‚­ãƒ³ã‚°ã—ã¦ã‚‚å•é¡Œã®è§£æ±ºã«ã¯ãªã‚‰ãªã„
- workType/UnitãŒã©ã‚Œã ã‘å¢—ãˆã¦ã‚‚å¯¾å¿œã§ãã‚‹ã‚ˆã†ãªã‚·ã‚¹ãƒ†ãƒ ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹

## æ–¹é‡

1. workType/Unitã‚’activityã®æƒ…å ±ã‚’ä½¿ã£ã¦äº‹å‰ã«çµã‚Šè¾¼ã‚€
2. 1ã§çµã‚Šè¾¼ã‚“ã workType/Unitã¨activityã‚’ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹

```mermaid
flowchart TD
  A["Activities"] --> B["ç‰¹å¾´æŠ½å‡ºï¼ˆpath/value/detailï¼‰"]
  WT["å·¥ç¨®ä½“ç³»ãƒã‚¹ã‚¿ï¼ˆwork_treeï¼‰"] --> C
  WT --> E
  subgraph "Step 1: å€™è£œã®çµã‚Šè¾¼ã¿"
    B --> C{"workType å€™è£œã®çµã‚Šè¾¼ã¿"}
    B --> E{"workUnit å€™è£œã®çµã‚Šè¾¼ã¿"}
    C --> D["å€™è£œ workType é›†åˆ"]
    E --> F["å€™è£œ workUnit é›†åˆ"]
  end
  subgraph "Step 2: ãƒãƒƒãƒ”ãƒ³ã‚°"
    D --> G{"ãƒãƒƒãƒ”ãƒ³ã‚°"}
    F --> G
    G --> H["activity ã« workType/Unit ã‚’ä»˜ä¸"]
  end
  H --> I["Activitiesï¼ˆãƒãƒƒãƒ”ãƒ³ã‚°æ¸ˆï¼‰"]
```

## Step 1: å€™è£œã®çµã‚Šè¾¼ã¿

- å€™è£œã®çµã‚Šè¾¼ã¿ã¯2æ®µéšã«åˆ†ã‘ã¦å®Ÿè£…ã™ã‚‹
    - Phase1. Long Contextã«å¼·ã„LLMã§workType/Unitã®å€™è£œã‚’çµã‚Šè¾¼ã‚€æ–¹æ³•
    - Phase2. workType/Unitã®ã‚¿ã‚°ã®ã‚ˆã†ãªæƒ…å ±ã‚’ä»˜åŠ ã—ã€LLMã§ã‚¿ã‚°ã®æ¤œç´¢æ¡ä»¶ã‚’ä½œæˆã™ã‚‹æ–¹æ³•
- Phase1ã®æ–¹æ³•ã¯æ ¹æœ¬çš„ãªè§£æ±ºã«ã¯ãªã£ã¦ã„ãªã„ã€‚LLMã®æ€§èƒ½ã«é ¼ã£ã¦ãŠã‚Šã€workType/Unitæ•°ãŒå¤šããªã£ãŸéš›ã«å€™è£œã®çµã‚Šè¾¼ã¿ãŒã§ããªããªã‚‹å¯èƒ½æ€§ãŒé«˜ã„ã€‚
- Phase2ã®æ–¹æ³•ã¯workType/Unitã®å¢—åŠ ã«å¯¾ã—ã¦ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ã§ã‚ã‚‹ãŒã€ä¸‹è¨˜ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹å¿…è¦ãŒã‚ã‚‹
    - ã©ã®ã‚ˆã†ãªã‚¿ã‚°ã‚’ä»˜ä¸ã™ã‚Œã°æ­£ç¢ºã«çµã‚Šè¾¼ã‚€ã“ã¨ãŒã§ãã‚‹ã®ã‹
    - ã©ã®ã‚ˆã†ãªã‚¿ã‚°ã‚’ä»˜ä¸ã™ã‚Œã°LLMãŒActivitiesã®ç‰¹å¾´é‡ã‹ã‚‰æ­£ç¢ºãªçµã‚Šè¾¼ã¿æƒ…å ±ã‚’ç”Ÿæˆã§ãã‚‹ã®ã‹
    - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®è² æ‹…ã‚’æœ€å°ã«ã—ãªãŒã‚‰ã€workType/Unitã®æƒ…å ±é‡ã‚’å¢—ã‚„ã™ã«ã¯ã©ã†ã™ã‚Œã°ã„ã„ã‹
- ã“ã‚Œã‚‰ã®å•é¡Œã«ã¯ã™ãã«å›ç­”ã§ããªã„ãŸã‚ã€ç›´è¿‘ã¯Phase1ã®æ–¹æ³•ã‚’æ¡ç”¨ã—ã€æ™‚æœŸã‚’è¦‹ã¦Phase2ã®æ–¹æ³•ã«ç§»è¡Œã™ã‚‹

### Phase1ã®èª²é¡Œ

- Phase1ã¯æ ¹æœ¬çš„ãªè§£æ±ºã«ãªã£ã¦ã„ãªã„ã€‚
- ãã®ãŸã‚ã€activityã‚’å…¨é‡æ¸¡ã™ã¨Context Windowã®ã‚µã‚¤ã‚ºã‚’è¶…ãˆã¦ã—ã¾ã†ã“ã¨ãŒæƒ³å®šã•ã‚Œã‚‹ã€‚
- ã‚ˆã£ã¦ã€activityã‚’ãƒãƒ£ãƒ³ã‚­ãƒ³ã‚°ã—ã¦ã€ä¸¦åˆ—å‡¦ç†ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚‹ã€‚

### å‡¦ç†æ‰‹é †

```
1. activity ã« level ã‚’ä»˜ä¸
2. ãƒ¬ãƒ™ãƒ«2ï¼ˆå·¥ç¨®ï¼‰ãƒ»ãƒ¬ãƒ™ãƒ«4ï¼ˆç´°åˆ¥ï¼‰ã®ã¿æŠ½å‡º
3. ä¸¦åˆ—å‡¦ç†: å·¥ç¨®ã”ã¨ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’ãƒãƒ£ãƒ³ã‚­ãƒ³ã‚°
4. ä¸¦åˆ—å‡¦ç†: ãƒãƒ£ãƒ³ã‚¯ã‹ã‚‰ç‰¹å¾´é‡ã‚’æŠ½å‡º
5. ä¸¦åˆ—å‡¦ç†: ç‰¹å¾´é‡ã‹ã‚‰ workType å€™è£œã‚’çµã‚Šè¾¼ã¿
6. ä¸¦åˆ—å‡¦ç†: 6 ã§çµã‚Šè¾¼ã‚“ã  workType ã«ç´ã¥ã workUnit å€™è£œã‚’æŠ½å‡º
7. ä¸¦åˆ—å‡¦ç†: ãƒ¬ãƒ™ãƒ«2ï¼ˆå·¥ç¨®ï¼‰ã¨ 6 ã® workType å€™è£œã‚’ãƒãƒƒãƒ”ãƒ³ã‚°
8. ä¸¦åˆ—å‡¦ç†: ãƒ¬ãƒ™ãƒ«4ï¼ˆç´°åˆ¥ï¼‰ã¨ 7 ã® workUnit å€™è£œã‚’ãƒãƒƒãƒ”ãƒ³ã‚°
9. ä¸¦åˆ—å‡¦ç†ã®çµæœï¼ˆ8, 9ï¼‰ã‚’çµåˆ
10. çµæœã‚’ workType / workUnit ã®å€™è£œã¨ã—ã¦è¿”å´
```

```mermaid
flowchart TD
  S["Start"] --> L["Step1: <br />activity ã« level ã‚’ä»˜ä¸"]
  L --> F["Step2: <br />ãƒ¬ãƒ™ãƒ«2/4ã®ã¿æŠ½å‡ºï¼ˆå·¥ç¨®/ç´°åˆ¥ï¼‰"]
  F --> C["Step3: <br />å·¥ç¨®ã”ã¨ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’ãƒãƒ£ãƒ³ã‚­ãƒ³ã‚°"]
  subgraph "Map-Reduceï¼ˆä¸¦åˆ—å‡¦ç†ï¼‰"
    C --> X["Step4: <br />ç‰¹å¾´é‡ã‚’æŠ½å‡º"]
    X --> WT["Step5: <br />workType å€™è£œã‚’çµã‚Šè¾¼ã¿"]
    X --> WU["Step6: <br />workUnit å€™è£œã‚’æŠ½å‡ºï¼ˆWTã«ç´ã¥ãï¼‰"]
    WT --> M2["Step7: <br />ãƒ¬ãƒ™ãƒ«2ï¼ˆå·¥ç¨®ï¼‰ã¨ workType å€™è£œã‚’ãƒãƒƒãƒ”ãƒ³ã‚°"]
    WU --> M4["Step8: <br />ãƒ¬ãƒ™ãƒ«4ï¼ˆç´°åˆ¥ï¼‰ã¨ workUnit å€™è£œã‚’ãƒãƒƒãƒ”ãƒ³ã‚°"]
  end
  M2 --> J["Step9: <br />çµæœã‚’çµåˆï¼ˆ8,9ï¼‰"]
  M4 --> J
  J --> R["Step10: <br />workType / workUnit ã®å€™è£œã¨ã—ã¦è¿”å´"]
  R --> E["End"]
```

### Step 1: activityã«levelã‚’ä»˜ä¸ / Step 2: ãƒ¬ãƒ™ãƒ«2/4ã®ã¿æŠ½å‡ºï¼ˆå·¥ç¨®/ç´°åˆ¥ï¼‰

- æ—¢å­˜å®Ÿè£…ã‚’ãã®ã¾ã¾ä½¿ç”¨ã™ã‚‹
    - `src/usecases/design_document/builders/map_reduce_graph_builder.py`
        - assign_levels
        - filter_activities

### Step 3: å·¥ç¨®ã”ã¨ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’ãƒãƒ£ãƒ³ã‚­ãƒ³ã‚°

- ãƒ¬ãƒ™ãƒ«2ï¼ˆå·¥ç¨®ï¼‰ã§ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«Contetext Windowå†…ã«åã¾ã‚‹ã¨ä»®å®šï¼‰
    - ç¾çŠ¶ã§ã¯Context Windowã‚’è¶…ãˆãŸå ´åˆã®åˆ†å‰²æˆ¦ç•¥ã¯è€ƒãˆãªã„
- åŒä¸€å·¥ç¨®å†…ã®activityã‚’ã¾ã¨ã‚ã‚‹ã“ã¨ã§ã€é–¢é€£æ€§ã®é«˜ã„é …ç›®ã‚’åŒã˜ãƒãƒ£ãƒ³ã‚¯ã§å‡¦ç†ã§ãã‚‹

### Step 4: ç‰¹å¾´é‡ã‚’æŠ½å‡ºï¼ˆä¸¦åˆ—å‡¦ç†ï¼‰

- å„ãƒãƒ£ãƒ³ã‚¯ã‹ã‚‰activityã®ç‰¹å¾´ã‚’æŠ½å‡ºã—ã€workType/Unitæ¤œç´¢ç”¨ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹
- éšå±¤æ§‹é€ ï¼ˆpathï¼‰ã€æ•°å€¤æƒ…å ±ï¼ˆvalueï¼‰ã€è©³ç´°èª¬æ˜ï¼ˆdetailï¼‰ã‹ã‚‰æ„å‘³çš„ãªç‰¹å¾´ã‚’æŠ½å‡ºã™ã‚‹

#### LLMã®é¸å®š

- LLMã¯openai/gpt-4oã‚’ä½¿ç”¨ã™ã‚‹
- ã“ã®å¾Œã®stepã§ã‚‚ç‰¹ã«æ–­ã‚ŠãŒãªã„é™ã‚Šã€openai/gpt-4oã‚’ä½¿ç”¨ã™ã‚‹

#### ä¸¦åˆ—å‡¦ç†

- ä¸¦åˆ—å‡¦ç†ã«ã¯LangGraphã®Map-Reduceãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹
    - add_conditional_edgesã‚’ä½¿ç”¨
    - `src/usecases/design_document/builders/map_reduce_graph_builder.py`ã‚’å‚è€ƒã«ã™ã‚‹
- ã‚‚ã—ã€ä¸¦åˆ—å‡¦ç†ã®ä¸€éƒ¨ãŒå¤±æ•—ã—ãŸå ´åˆã¯å…¨ä½“ã‚’å¤±æ•—ã¨ã™ã‚‹

```
  ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹:
  ä»¥ä¸‹ã®è¨­è¨ˆæ›¸ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‹ã‚‰ã€å·¥äº‹ç¨®åˆ¥ã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã®ç‰¹å¾´ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ï¼š
  - ä½œæ¥­å†…å®¹ã€ä½¿ç”¨ææ–™ã€æ–½å·¥æ–¹æ³•ã€å˜ä½ãªã©ã®è¦³ç‚¹ã‹ã‚‰åˆ†æ
  - å„ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã®å…±é€šç‚¹ã¨ç›¸é•ç‚¹ã‚’æ˜ç¢ºåŒ–
```

### Step 5: workTypeå€™è£œã‚’çµã‚Šè¾¼ã¿ï¼ˆä¸¦åˆ—å‡¦ç†ï¼‰

- Step 4ã§æŠ½å‡ºã—ãŸç‰¹å¾´é‡ã‚’åŸºã«ã€ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã®workTypeã‹ã‚‰é–¢é€£æ€§ã®é«˜ã„å€™è£œã‚’é¸å®šã™ã‚‹
- å„ãƒãƒ£ãƒ³ã‚¯ã”ã¨ã«ä¸Šä½10-20å€‹ç¨‹åº¦ã®workTypeå€™è£œã‚’æŠ½å‡ºã™ã‚‹
- Long Contextã«ãªã‚‹ã“ã¨ãŒæƒ³å®šã•ã‚Œã‚‹ã®ã§`gemini/gemini-2.5-flash`ã‚’ä½¿ç”¨ã™ã‚‹
  - `LangChainManage`ã«`get_chat_gemini`ã‚’è¿½åŠ 

```
  ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹:
  ç‰¹å¾´é‡: [åœŸç ‚æ˜å‰Š, æ©Ÿæ¢°æ–½å·¥, m3å˜ä½, åŸºç¤å·¥äº‹é–¢é€£]
  ä»¥ä¸‹ã®workTypeãƒã‚¹ã‚¿ã‹ã‚‰æœ€ã‚‚é–¢é€£æ€§ã®é«˜ã„ã‚‚ã®ã‚’é¸å®šã—ã¦ãã ã•ã„ï¼š
  [ãƒã‚¹ã‚¿ãƒªã‚¹ãƒˆ] â†’ å€™è£œã¨ã—ã¦ã€ŒåœŸå·¥ã€ã€ŒåŸºç¤å·¥ã€ç­‰ã‚’é¸å®š
```

### Step 6: workUnitå€™è£œã‚’æŠ½å‡ºï¼ˆä¸¦åˆ—å‡¦ç†ï¼‰

- Step 5ã§çµã‚Šè¾¼ã‚“ã workTypeã«ç´ã¥ãworkUnitã‚’ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ã§æŠ½å‡ºã™ã‚‹

### Step 7: ãƒ¬ãƒ™ãƒ«2ï¼ˆå·¥ç¨®ï¼‰ã¨workTypeå€™è£œã‚’ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆä¸¦åˆ—å‡¦ç†ï¼‰

- ãƒ¬ãƒ™ãƒ«2ã®activityã¨ã€Step 5ã§çµã‚Šè¾¼ã‚“ã workTypeå€™è£œã‚’1å¯¾1ã§ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹
- åç§°ã®é¡ä¼¼åº¦ã€éšå±¤çš„ãªä½ç½®ã¥ã‘ã€é–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ç·åˆçš„ã«è©•ä¾¡ã—ã¦ãƒãƒƒãƒãƒ³ã‚°ã™ã‚‹

```
  ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹:
  Activityï¼ˆãƒ¬ãƒ™ãƒ«2ï¼‰: "åœŸå·¥"
  WorkTypeå€™è£œ: ["åœŸå·¥äº‹", "æ˜å‰Šå·¥", "åŸºç¤åœŸå·¥"] â†’ æœ€ã‚‚é©åˆ‡ãªworkTypeã‚’é¸å®šã—ã€ç†ç”±ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚
```

### Step 8: ãƒ¬ãƒ™ãƒ«4ï¼ˆç´°åˆ¥ï¼‰ã¨workUnitå€™è£œã‚’ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆä¸¦åˆ—å‡¦ç†ï¼‰

- ãƒ¬ãƒ™ãƒ«4ã®activityã¨ã€Step 6ã§æŠ½å‡ºã—ãŸworkUnitå€™è£œã‚’ãƒãƒƒãƒ”ãƒ³ã‚°ã™ã‚‹
- è¦ªã¨ãªã‚‹workTypeã¨ã®æ•´åˆæ€§ã‚’ä¿ã¡ãªãŒã‚‰ã€è©³ç´°ãƒ¬ãƒ™ãƒ«ã§ã®å¯¾å¿œä»˜ã‘ã‚’è¡Œã†

```
  ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¾‹:
  Activityï¼ˆãƒ¬ãƒ™ãƒ«4ï¼‰: "åœŸç ‚æ˜å‰Šï¼ˆå°è¦æ¨¡ï¼‰_10m3æœªæº€"
  WorkUnitå€™è£œ: ["æ©Ÿæ¢°æ˜å‰Š_å°è¦æ¨¡", "äººåŠ›æ˜å‰Š", "ãƒãƒƒã‚¯ãƒ›ã‚¦æ˜å‰Š_0.28m3"] â†’ æŠ€è¡“çš„ä»•æ§˜ãªã©ã‚’è€ƒæ…®ã—ã¦æœ€é©ãªworkUnitã‚’é¸å®šã—ã¦ãã ã•ã„ã€‚
```

### Step 9: çµæœã‚’çµåˆ

- å„ä¸¦åˆ—å‡¦ç†ã®çµæœã‚’çµ±åˆã—ã€activityå…¨ä½“ã®ãƒãƒƒãƒ”ãƒ³ã‚°çµæœã‚’æ§‹ç¯‰ã™ã‚‹
- ãƒãƒ£ãƒ³ã‚¯é–“ã§é‡è¤‡ã‚„çŸ›ç›¾ãŒã‚ã‚‹å ´åˆã¯ã€ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ã«åŸºã¥ã„ã¦èª¿æ•´ã™ã‚‹
- éšå±¤æ§‹é€ ã®æ•´åˆæ€§ï¼ˆè¦ªå­é–¢ä¿‚ï¼‰ã‚’æ¤œè¨¼ã—ã€å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£ã™ã‚‹

### Step 10: workType/workUnitã®å€™è£œã¨ã—ã¦è¿”å´

- æœ€çµ‚çš„ãªãƒãƒƒãƒ”ãƒ³ã‚°çµæœã‚’æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦æ•´å½¢ã™ã‚‹
- å„activityã«å¯¾ã—ã¦ã€é¸å®šã•ã‚ŒãŸworkType/workUnitã‚’ä»˜ä¸ã™ã‚‹

### æ—¢å­˜ã®Aggregationã«è¿½åŠ ã™ã¹ããƒ¡ã‚½ãƒƒãƒ‰

1. ExtractedData.get_activities_by_level
    - å‡¦ç†æ¦‚è¦: æŒ‡å®šã•ã‚ŒãŸãƒ¬ãƒ™ãƒ«ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã®ã¿ã‚’æŠ½å‡ºã—ã¦è¿”ã™
    - ä½¿ç”¨ã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—: Step 2ï¼ˆãƒ¬ãƒ™ãƒ«2/4ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£æŠ½å‡ºï¼‰

2. ExtractedData.create_activity_chunks_by_work_type

    - å‡¦ç†æ¦‚è¦: ãƒ¬ãƒ™ãƒ«2ï¼ˆå·¥ç¨®ï¼‰ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’åŸºæº–ã«ã€é–¢é€£ã™ã‚‹ä¸‹ä½ãƒ¬ãƒ™ãƒ«ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚‚å«ã‚ã¦ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã€ãƒãƒ£ãƒ³ã‚¯ã‚’ä½œæˆã™ã‚‹
    - è£œè¶³: chunk_idã¯UUIDã§ã‚ˆã„ï¼ˆå®Ÿè¡Œã”ã¨ã«IDã¯å¤‰ã‚ã‚‹ï¼‰
    - ä½¿ç”¨ã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—: Step 3ï¼ˆå·¥ç¨®ã”ã¨ã®ãƒãƒ£ãƒ³ã‚­ãƒ³ã‚°ï¼‰

### Graph State

```python
class MappingGraphState(BaseModel):
      """ãƒãƒƒãƒ”ãƒ³ã‚°å‡¦ç†å…¨ä½“ã®çŠ¶æ…‹"""
      tenant_id: str
      site_id: str
      extracted_data: DesignDocumentExtraction
      work_tree: WorkTree

      # ä¸¦åˆ—å‡¦ç†ã®ä¸­é–“çµæœ
      chunk_features: dict[str, list[str]] | None = None  # Step 4ã®çµæœï¼ˆchunk_id â†’ featuresï¼‰
      work_type_candidates: dict[str, list[str]] | None = None  # Step 5ã®çµæœï¼ˆchunk_id â†’ work_type_idsï¼‰
      work_unit_candidates: dict[str, list[str]] | None = None  # Step 6ã®çµæœï¼ˆchunk_id â†’ work_unit_idsï¼‰

      # ãƒãƒƒãƒ”ãƒ³ã‚°çµæœ
      level_2_mappings: dict[str, str] | None = None  # Step 7ã®çµæœï¼ˆactivity_id â†’ work_type_idï¼‰
      level_4_mappings: dict[str, str] | None = None  # Step 8ã®çµæœï¼ˆactivity_id â†’ work_unit_idï¼‰

      # æœ€çµ‚çµæœ
      final_mappings: list[MapWorkTreeMasterOutputItem] | None = None  # Step 9-10ã®çµæœ
```

### ãƒãƒ£ãƒ³ã‚¯å®šç¾©ï¼ˆStep 3ã§ä½œæˆï¼‰

```python
  class ActivityChunk(BaseModel):
      """å·¥ç¨®ã”ã¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒãƒ£ãƒ³ã‚¯"""
      chunk_id: str
      work_type_name: str  # ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã®åŸºæº–ã¨ãªã£ãŸå·¥ç¨®å
      activity_ids: list[str]  # ã“ã®ãƒãƒ£ãƒ³ã‚¯ã«å«ã¾ã‚Œã‚‹activity_id

### LLM Outputå®šç¾©ï¼ˆå„ã‚¹ãƒ†ãƒƒãƒ—ã®å‡ºåŠ›ï¼‰


- Step 1: AssignLevelOutputï¼ˆæ—¢å­˜ï¼‰

```python
  class AssignLevelOutput(BaseModel):
      """ãƒ¬ãƒ™ãƒ«å‰²ã‚Šå½“ã¦ã®çµæœ"""
      items: list[AssignLevelOutputItem]
```

- Step 4: FeatureExtractionOutput

```python
  class FeatureExtractionOutput(BaseModel):
      """ç‰¹å¾´é‡æŠ½å‡ºã®çµæœ"""
      chunk_id: str
      features: list[str]  # æŠ½å‡ºã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
      semantic_summary: str  # æ„å‘³çš„ãªè¦ç´„
```

- Step 5: WorkTypeCandidateOutput

```python
  class WorkTypeCandidateOutput(BaseModel):
      """workTypeå€™è£œçµã‚Šè¾¼ã¿ã®çµæœ"""
      chunk_id: str
      candidates: list[WorkTypeCandidate]

  class WorkTypeCandidate(BaseModel):
      work_type_id: str
      work_type_name: str
      relevance_score: float
```

- Step 7: Level2MappingOutput

```python
  class Level2MappingOutput(BaseModel):
      """ãƒ¬ãƒ™ãƒ«2ãƒãƒƒãƒ”ãƒ³ã‚°ã®çµæœ"""
      mappings: list[Level2Mapping]

  class Level2Mapping(BaseModel):
      activity_id: str
      work_type_id: str
      confidence: float
      reason: str
```
- Step 8: Level4MappingOutput

```python
  class Level4MappingOutput(BaseModel):
      """ãƒ¬ãƒ™ãƒ«4ãƒãƒƒãƒ”ãƒ³ã‚°ã®çµæœ"""
      mappings: list[Level4Mapping]

  class Level4Mapping(BaseModel):
      activity_id: str
      work_unit_id: str
      confidence: float
      reason: str
```

- Step 10: MapWorkTreeMasterOutputï¼ˆæ—¢å­˜ï¼‰

```python
  class MapWorkTreeMasterOutput(BaseModel):
      """æœ€çµ‚çš„ãªãƒãƒƒãƒ”ãƒ³ã‚°çµæœ"""
      items: list[MapWorkTreeMasterOutputItem]
```
