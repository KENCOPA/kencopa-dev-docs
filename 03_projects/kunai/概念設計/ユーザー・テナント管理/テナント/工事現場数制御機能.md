---
type: note
moc: `[[🏷️概念設計書]]`
---
# 工事現場数制御機能（Draft対応版）

## 全体概要

### 概要

本設計書は、テナント内の工事現場を「Draft（仮現場）」「Active（稼働中）」「Archived（完了済）」の3ステータスで管理し、
現場単位課金の仕組みと機能制御を一貫して行うための概念設計である。

本機能により、見積・入札段階からAI工程表を試す「Draft利用」を可能にしつつ、
正式な現場稼働（Active）に移行した段階で自動的に課金が開始される。
完了後はArchived状態となり、閲覧専用・非課金としてデータを保持する。

### ビジネス目標

---

## 現場ステータス管理（Draft / Active / Archived）
### ステータス

* [x] 検討中（PdMが要件を整理している段階）
* [x] 概念設計中（PdMが概念設計を行っている段階）
* [ ] 概念設計確定（PdMが概念設計を固め、エンジニアに渡せる状態）
* [ ] 実装中（Engが開発中）
* [ ] 実装完了（機能がリリース済み）
* [ ] 不採用（検討の結果ボツになったもの）
### 機能概要

現場を3つのステータスで運用し、状態に応じて利用可能機能と課金対象を切り替える。
現場の状態はユーザー操作または自動処理によって遷移し、ステータスごとに利用制約が明確に定義される。

| ステータス        | 主な利用機能             | 課金対象 | 有効期限 | 備考        |
| ------------ | ------------------ | ---- | ---- | --------- |
| **Draft**    | AI工程表生成のみ（編集・共有不可） | ❌    | 14日間 | 無料体験・見積用  |
| **Active**   | 編集・AI・出力すべて利用可     | ✅    | 無期限  | 稼働現場として課金 |
| **Archived** | 閲覧・出力のみ            | ❌    | 無期限  | 完了現場として保存 |

### ビジネス目標

* 現場の状態と課金の関係を明確にし、ユーザーにわかりやすい運用ルールを提供する。
* 状態遷移を通じて、「体験→正式利用→完了」のライフサイクルを自然に形成する。
* データを消さずに運用・課金を切り替える柔軟な現場管理を可能にする。

### 機能要件

#### 見積段階の現場担当者として、正式な現場登録前にAI工程表を試したい。
Draft現場を作成し、AI生成を最大n回まで利用できる。
編集・出力・共有は不可。
Draftは作成から14日経過で自動アーカイブ化される。

#### Draft現場を正式な稼働現場にしたい。
→ 「Activeに昇格」操作を行うことで、AI・編集・出力などすべての機能が解放され、課金対象となる。
→ 昇格時に課金イベントが自動で発生し、翌月の請求対象に登録される。

#### 完了済みの現場を保持したまま、課金を停止したい。
→ 「完了」操作でArchivedに移行し、閲覧専用となる。
→ 翌月の請求から除外され、AI機能は停止される。

---

## Draft利用制御（上限・制限・自動削除）
### ステータス

* [x] 検討中（PdMが要件を整理している段階）
* [x] 概念設計中（PdMが概念設計を行っている段階）
* [ ] 概念設計確定（PdMが概念設計を固め、エンジニアに渡せる状態）
* [ ] 実装中（Engが開発中）
* [ ] 実装完了（機能がリリース済み）
* [ ] 不採用（検討の結果ボツになったもの）
### 機能概要

Draft現場の不正利用を防ぐために、作成件数・利用期間・AI利用回数などを自動的に制御する。
この仕組みにより、Draftを「体験空間」として限定し、恒常的な無課金利用を不可能にする。

### ビジネス目標
現場単位での公平な課金体系の実現
　利用実態（編集・AI利用・出力など）に基づいて現場単位で課金を行い、使った分だけ支払う構造を実現する。
　非稼働の現場や完了済み現場には課金を発生させず、説明性の高い料金設計とする。

業務ライフサイクルに沿ったステータス管理
　見積・入札段階（Draft）、稼働段階（Active）、完了段階（Archived）を明確に区分し、
　それぞれに適した機能制御・保存方法・課金ロジックを自動で適用する。

不正運用・課金回避の防止
　Draftやステータス変更を利用した恒常的な無課金運用を防ぎ、
　「動いている現場だけが課金される」透明かつ公平な仕組みを維持する。

ユーザーが理解できる明確な構造
　現場の状態（Draft／Active／Archived）がそのまま料金・機能・権限に対応する構造とし、
　営業・CS・ユーザーすべてが直感的に理解できる課金モデルを確立する。

運用コスト・監査コストの削減
　状態と課金処理をシステムで同期させ、営業／CS／管理部門での人的対応を最小限にする。

### 機能要件

#### ユーザーとして、Draft現場を複数作成しようとしたが上限に達している。
→ システムは作成をブロックし、「Draft上限に達しました。不要なDraftを削除するか、Activeに昇格してください。」と通知する。

#### Draftを14日以上放置した場合。
→ システムが自動的にアーカイブ化し、「Draftの有効期限が切れました」と通知する。

#### DraftのAI利用上限に達した場合。
→ 「Draftではこれ以上AIを利用できません。Activeに昇格して継続利用してください。」と表示する。

---

## 現場課金連動

### 機能概要

現場の状態変化（Draft→Active／Active→Archived）に応じて課金イベントを自動的に生成・管理する。
ユーザーが現場を手動で切り替えるだけで、課金処理・非課金処理が自動的に反映される。

### ビジネス目標

* 状態と課金を完全に同期させ、営業・CS・法務対応を簡素化する。
* 「今月どの現場が課金対象か」を可視化し、透明性を担保する。
* 手動の請求管理を廃止し、PLG／SLG双方の運用コストを削減する。

### 機能要件

#### Active化した現場の課金を自動で反映したい。
→ Draft→Active切り替え時に `billing_event("activate")` を発行し、
　Billingシステムが当月スナップショットに登録する。

#### 完了した現場を課金対象から外したい。
→ Active→Archived切り替え時に `billing_event("deactivate")` を発行し、
　翌月の請求から除外する。

#### 月末時点での課金確定を確認したい。
→ システムは「当月Active現場一覧」を表示する。

---

## 不正利用検知・監査ログ

### 機能概要

Draftや課金イベントの異常利用を監視し、不正利用やシステム的抜け道を検知する。
Draft作成・削除・昇格などの行動を監査ログに記録する。

### ビジネス目標

* 無料利用の乱用やアカウントの悪用を早期に発見する。
* システム上で課金回避行動が起きた場合に自動検知できる仕組みを作る。

### 機能要件

#### 短期間に複数のDraftが作成・削除されている場合。
→ システムは異常値を検出し、`audit_flag: suspicious_activity` を付与する。
→ 一定閾値を超えた場合、Draft作成を一時的に制限する。

#### 課金対象の現場を手動でArchivedに戻して当月課金を避けようとする場合。
→ システムは「当月中にAI利用・編集実行があった現場」は課金確定として扱い、
　翌月からのみ非課金扱いにする。

---



