---
type: note
moc: "[[🏷️基本設計書]]"
tags:
- '#ai/ref'
---
# 🎯 目的・対象範囲

## 目的
kunai-core-frontendにおいて、設計図書等のファイルアップロード・削除機能を実装する。従来のクライアントサイド直接アップロード方式とは異なり、Next.js Route Handler（サーバーサイド）を経由してオブジェクトストレージ（S3）にアップロードする新しいアーキテクチャを採用する。

## 対象範囲
- **対象システム**: kunai-core-frontend
- **対象機能**: ファイルアップロード、ファイル削除、複数ファイル一括処理
- **対象ファイル**: 設計図書（PDF、画像、Office文書等）
- **対象環境**: ローカル開発環境（LocalStack）、本番環境（AWS S3）

# 🏗 システム構成概要

## アーキテクチャの特徴

### 従来方式との違い
**従来方式（azuchi等）**: フロントエンド（クライアントサイド） → S3（直接アクセス）
**新方式（kunai）**: フロントエンド → Next.js Route Handler（サーバーサイド） → S3

### なぜこの方式を選択したか
1. **セキュリティ強化**: サーバーサイド実行により、クライアントサイドでは実現困難なセキュリティ制御を実装
2. **統合されたアーキテクチャ**: Next.js Route Handlerにより、フロントエンドとバックエンドの中間層として機能し、既存のNext.jsアーキテクチャとの親和性を確保
   - **認証・認可の確実な実行**: フロントエンドでは改ざん可能な認証チェックも、サーバーサイドでは確実に実行される
   - **環境変数の保護**: AWS認証情報などの機密情報がクライアントに露出しない
   - **ファイル検証の信頼性**: ファイルサイズやMIME Typeの検証をクライアントが迂回できない
   - **アップロード先の制御**: S3のバケット名やパスをサーバーサイドで決定し、クライアントが任意の場所にアップロードできない
3. **スケーラビリティ**: メインのバックエンドAPIのリソース消費を抑制し、ファイルアップロード処理の負荷分散

> **補足**: 従来のクライアントサイド直接アップロードと異なり、Next.js Route Handler（サーバーサイド）が仲介することで、セキュリティポリシーを確実に適用しながらS3への直接アップロードの利点を活用できます。

## 高レベルアーキテクチャ図

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   React Hook    │───▶│ Next.js Route    │───▶│ Object Storage  │
│   (Frontend)    │    │ Handler (API)    │    │ Client Factory  │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                                         │
                                                         ▼
                                               ┌─────────────────┐
                                               │ LocalS3Client / │
                                               │ AwsS3Client     │
                                               └─────────────────┘
                                                         │
                                                         ▼
                                               ┌─────────────────┐
                                               │ LocalStack /    │
                                               │ AWS S3          │
                                               └─────────────────┘
```

## 主要コンポーネント一覧

1. **React Query Hooks**: ファイルアップロード・削除の状態管理
2. **Next.js Route Handlers**: `/api/files/upload`, `/api/files/delete`
3. **Object Storage Client Factory**: 環境に応じたS3クライアントの切り替え
4. **Type Definitions**: TypeScript型定義による型安全性の確保

# 🛠 基本設計

## モジュール構成

```text
src/
├─ app/api/files/
│  ├─ upload/route.ts          # ファイルアップロードAPI
│  └─ delete/route.ts          # ファイル削除API
├─ services/files/
│  ├─ hooks/                   # React Query hooks
│  │  ├─ use-file-upload-mutation.ts
│  │  ├─ use-file-delete-mutation.ts
│  │  ├─ use-multiple-file-upload.ts
│  │  ├─ use-multiple-file-delete.ts
│  │  └─ use-multiple-file-management.ts
│  ├─ functions.ts             # API呼び出し関数
│  └─ types.ts                 # 型定義
└─ services/shared/clients/objectStorageClient/
   ├─ factory.ts               # Factory Pattern実装
   ├─ interfaces.ts            # 共通インターフェース
   ├─ s3.ts                    # AWS S3クライアント
   └─ localS3Client.ts         # LocalStack用クライアント
```

## データモデル

### ファイルアップロード関連型

| 型名 | 説明・補足 |
|:-----|:----------|
| FileUploadParams | アップロード時のパラメータ（file: File, key: string） |
| FileUploadResult | アップロード結果（success: true, url: string, key: string） |
| FileDeleteParams | 削除時のパラメータ（key: string） |
| FileDeleteResult | 削除結果（success: true, key: string） |
| UploadedFileInfo | アップロード済みファイル情報（file, url, key, category?） |
| FileCategory | ファイルカテゴリ（"overview" \| "quantity" \| "specification" \| "diagram"） |

### オブジェクトストレージクライアント

| インターフェース | 説明・補足 |
|:----------------|:----------|
| ObjectStorageClient | 共通インターフェース（put, delete メソッド） |
| PutObjectOptions | アップロードオプション（contentType, contentLength, metadata） |

## API 仕様

| エンドポイント | メソッド | リクエスト | レスポンス |
|:--------------|:---------|:----------|:----------|
| /api/files/upload | POST | FormData(file, key) | {success: true, url: string, key: string, originalName: string} |
| /api/files/delete | DELETE | {key: string} | {success: true, key: string} |

### リクエスト例
```javascript
// アップロード
const formData = new FormData();
formData.append("file", file);
formData.append("key", "documents/2025/design-001.pdf");

// 削除
const deleteRequest = {
  key: "documents/2025/design-001.pdf"
};
```

# 🔧 非機能要件対応

## セキュリティ要件
- **ファイルサイズ制限**: 現在未実装（要検討：50MB制限推奨）
- **ファイル形式検証**: 現在未実装（要検討：PDF、画像、Office文書のみ許可）
- **ファイル名サニタイゼーション**: HTTPヘッダー安全な形式でエンコード済み
- **権限チェック**: 削除時の権限チェックは現在未実装

## 性能要件
- **並列アップロード**: Promise.allによる複数ファイル同時アップロード対応
- **エラーハンドリング**: 部分的失敗時の処理（Promise.allSettledの検討推奨）
- **ローディング状態**: React Query による適切な状態管理

## 可用性・スケーラビリティ
- **環境切り替え**: Factory Patternによる開発環境（LocalStack）と本番環境（AWS S3）の自動切り替え
- **クライアント抽象化**: ObjectStorageClientインターフェースによる実装の抽象化

## 環境対応
- **ローカル開発**: LocalStack（http://localhost:4566）
- **本番環境**: AWS S3（現在URL構築ロジックは要修正）

# 🚀 リリース・移行手順

## 環境変数設定
```bash
# 必須環境変数
S3_DESIGN_DOCUMENTS_BUCKET_NAME=kunai-design-documents
AWS_REGION=ap-northeast-1
NEXT_PUBLIC_ENV=local  # local | staging | production
```

## デプロイ前チェックリスト
- [ ] 環境変数の設定確認
- [ ] S3バケットの作成・権限設定
- [ ] LocalStack環境での動作確認
- [ ] ファイルサイズ・形式制限の実装（推奨）
- [ ] エラーハンドリングの改善（推奨）

## ロールバック計画
- アップロード済みファイルは削除APIで個別削除可能
- 機能無効化は環境変数またはフィーチャーフラグで制御

# 📚 設計上の重要な判断

## Factory Patternの採用理由
環境に応じてLocalS3ClientとAwsS3Clientを切り替える必要があるため、Factory Patternを採用。これにより：
- テスタビリティの向上
- 環境依存コードの分離
- 将来的な他のストレージサービス対応の容易さ

## React Query Hooksの活用
ファイルアップロード・削除処理において：
- キャッシュ管理の自動化
- エラーハンドリングの統一
- ローディング状態の一元管理
- 楽観的更新の実装容易性

## Next.js Route Handlerの選択理由
- サーバーサイド実行によるセキュリティ確保
- フロントエンドとバックエンドの中間層として機能
- FormData処理の簡潔な実装
- 既存のNext.jsアーキテクチャとの親和性

# 🔍 今後の改善点

## セキュリティ強化
1. ファイルサイズ上限の実装（推奨：50MB）
2. MIME Type検証の追加
3. ファイル削除時の権限チェック実装
4. ファイルスキャン（ウイルスチェック）の検討

## エラーハンドリング改善
1. Promise.allSettledによる部分的失敗対応
2. リトライ機能の実装
3. ユーザーフレンドリーなエラーメッセージ

## パフォーマンス最適化
1. 大量ファイル同時アップロード時の並列数制限
2. プログレス表示の実装
3. チャンク分割アップロードの検討

## 運用面の改善
1. アップロード履歴の管理（バックエンド側実装）
2. ファイルメタデータの永続化
3. 監視・ログ機能の強化

---

**関連リンク**
- [PR #34: 設計図書等アップロード機能 step4](https://github.com/KENCOPA/kunai-core-frontend/pull/34)
- [[🗒️ 000018-日報ファイルアップロードにreact-dropzoneライブラリを使用する]]
- [[🗒️ 000020-日報のファイルサイズ上限は25MBとする]]
